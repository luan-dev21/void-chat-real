<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VOID CHAT</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDKs CDN (Compat Version 9.6.1) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  
  <!-- Font Awesome CDN for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Google Fonts: Orbitron -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      overflow: hidden;
    }
    .neon-border-cyan {
      box-shadow: 0 0 3px rgba(0, 255, 255, 0.8), 0 0 5px rgba(0, 255, 255, 0.6), 0 0 10px rgba(0, 255, 255, 0.4);
    }
    .neon-border-green {
      box-shadow: 0 0 3px rgba(57, 255, 20, 0.8), 0 0 5px rgba(57, 255, 20, 0.6), 0 0 10px rgba(57, 255, 20, 0.4);
    }
    .neon-text-cyan {
      text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
    }
    .neon-text-green {
       text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14;
    }
    .neon-text-red {
       text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000;
    }
    .neon-button-glow {
      transition: all 0.2s ease-in-out;
    }
    .neon-button-glow:hover {
      box-shadow: 0 0 5px #00ffff, 0 0 15px #00ffff, 0 0 25px #00ffff;
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 2px #39FF14, 0 0 4px #39FF14; }
      50% { box-shadow: 0 0 6px #39FF14, 0 0 12px #39FF14; }
    }
     @keyframes pulse-red {
      0%, 100% { text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
      50% { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000; }
    }
    @keyframes pulse-red-dot {
        0%, 100% { box-shadow: 0 0 3px #ff0000, 0 0 5px #ff0000; }
        50% { box-shadow: 0 0 8px #ff0000, 0 0 12px #ff0000; }
    }
    .pulse-dot {
      animation: pulse-green 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
    }
     .recording-active {
        animation: pulse-red 1.5s infinite;
        color: #ff0000;
    }
    .notification-dot {
        animation: pulse-red-dot 1.5s infinite;
    }
    @keyframes pulse-premium {
        0%, 100% { box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7; }
        50% { box-shadow: 0 0 15px #a855f7, 0 0 25px #a855f7; }
    }
    .neon-premium-glow {
        animation: pulse-premium 2.5s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    .animated-stars {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: 
        radial-gradient(1px 1px at 20% 30%, #fff, transparent), radial-gradient(1px 1px at 80% 10%, #fff, transparent),
        radial-gradient(1px 1px at 50% 70%, #fff, transparent), radial-gradient(2px 2px at 90% 80%, #fff, transparent),
        radial-gradient(2px 2px at 10% 90%, #fff, transparent);
      background-repeat: repeat; background-size: 300px 300px; animation: zoom 15s infinite alternate; opacity: 0.5;
    }
    @keyframes zoom {
      from { transform: scale(1); }
      to { transform: scale(1.2); }
    }
    /* Hide scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-black text-white w-screen h-screen overflow-hidden">
  <div class="animated-stars"></div>

  <!-- Loading Overlay (Global) -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex-col items-center justify-center z-50">
    <div class="w-16 h-16 border-4 border-dashed border-cyan-500 rounded-full animate-spin"></div>
    <p id="loading-msg" class="text-xl text-cyan-400 tracking-wider mt-4">Verificando login...</p>
  </div>

  <!-- Login Screen -->
  <div id="login-screen" class="hidden w-full h-full flex items-center justify-center p-4 relative z-10">
    <div class="w-full max-w-md bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-8 neon-border-cyan space-y-6">
      <div class="text-center">
        <h1 class="text-4xl font-black text-white neon-text-green">VOID CHAT</h1>
        <p class="text-cyan-400 neon-text-cyan text-sm">Acesse o Vazio.</p>
      </div>
      <form id="login-form" class="space-y-4">
        <div>
          <label for="email" class="block text-cyan-400 text-sm mb-1">Email</label>
          <input type="email" id="email" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
        </div>
        <div>
          <label for="password" class="block text-cyan-400 text-sm mb-1">Senha</label>
          <input type="password" id="password" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
        </div>
        <p id="auth-error" class="text-red-500 text-xs text-center h-4"></p>
        <div class="space-y-2">
            <button type="submit" id="login-btn" class="w-full font-bold py-2 px-4 rounded-md text-white bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 transition-all">Entrar</button>
            <button type="button" id="signup-btn" class="w-full font-bold py-2 px-4 rounded-md text-cyan-400 border-2 border-cyan-400 hover:bg-cyan-400 hover:text-black transition-all">Criar Conta</button>
        </div>
      </form>
      <div class="flex items-center text-gray-500">
        <hr class="flex-grow border-gray-700" />
        <span class="px-2 text-xs">OU</span>
        <hr class="flex-grow border-gray-700" />
      </div>
       <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 font-sans font-medium py-2 px-4 rounded-md text-black bg-white hover:bg-gray-200 transition-all">
          <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
          Entrar com Google
      </button>
    </div>
  </div>

  <!-- Profile Creation Modal -->
  <div id="profile-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
      <div class="w-full max-w-lg bg-black/50 border border-cyan-500 rounded-lg p-8 neon-border-cyan animate-pulse space-y-6">
          <div class="text-center">
              <h1 class="text-3xl font-bold text-white neon-text-green">COMPLETE SEU PERFIL</h1>
              <p class="text-cyan-400 neon-text-cyan text-sm">Sua identidade para mergulhar no Vazio.</p>
          </div>
          <form id="profile-form" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label for="username-input" class="block text-cyan-400 text-sm mb-1">Username</label>
                      <input type="text" id="username-input" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                  </div>
                  <div>
                      <label for="gender-select" class="block text-cyan-400 text-sm mb-1">Sexo</label>
                      <select id="gender-select" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                          <option value="">Selecione...</option>
                          <option value="Masculino">Masculino</option>
                          <option value="Feminino">Feminino</option>
                          <option value="Outro">Outro</option>
                      </select>
                  </div>
                  <div>
                      <label for="region-select" class="block text-cyan-400 text-sm mb-1">Região (Estado)</label>
                      <select id="region-select" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                        <!-- Options will be populated by JS -->
                      </select>
                  </div>
                   <div>
                      <label for="interests-input" class="block text-cyan-400 text-sm mb-1">Interesses</label>
                      <input type="text" id="interests-input" placeholder="Games, Música, etc" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                  </div>
              </div>
               <div>
                  <label for="avatar-input" class="block text-cyan-400 text-sm mb-1">URL da Foto de Perfil / Avatar</label>
                  <input type="url" id="avatar-input" placeholder="https://exemplo.com/imagem.png" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
              </div>

              <p id="full-profile-error" class="text-red-500 text-xs text-center h-4"></p>
              <button type="submit" id="save-full-profile-btn" class="w-full font-bold py-3 px-4 rounded-md text-black bg-cyan-400 neon-button-glow transition-all text-lg">SALVAR NO VAZIO</button>
          </form>
      </div>
  </div>

  <!-- Home Screen -->
    <div id="home-screen" class="hidden w-full h-full flex flex-col justify-center items-center p-4 relative z-10">
        <div class="text-center mb-12">
            <h1 class="text-6xl md:text-8xl font-black text-white neon-text-green tracking-widest">VOID CHAT</h1>
            <p class="text-cyan-400 mt-4 neon-text-cyan">ESCOLHA SEU CAMINHO NO VAZIO.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-4xl">
            <!-- Card 1: Global Chat -->
            <div id="global-chat-card" class="bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-900/50 transition-all cursor-pointer">
                <i class="fas fa-globe text-4xl text-cyan-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">CHAT GLOBAL</h2>
                <p class="text-gray-400 text-sm mt-2">Converse com todos os usuários online em uma única sala.</p>
            </div>

            <!-- Card 2: Random Void (Matchmaking) -->
            <div id="match-btn" class="bg-white/5 backdrop-blur-md border-2 border-cyan-400 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-800/60 transition-all cursor-pointer transform hover:scale-105">
                <i class="fas fa-random text-4xl text-cyan-300 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">RANDOM VOID</h2>
                <p class="text-gray-300 text-sm mt-2">Mergulhe no desconhecido e encontre uma conexão anônima aleatória.</p>
            </div>

            <!-- Card 3: Private Chat -->
            <div id="private-chat-card" class="relative bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-900/50 transition-all cursor-pointer">
                <div id="private-chat-notification" class="hidden absolute top-3 right-3 w-4 h-4 bg-red-500 rounded-full border-2 border-black notification-dot"></div>
                <i class="fas fa-user-secret text-4xl text-cyan-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">CHAT PRIVADO</h2>
                <p class="text-gray-400 text-sm mt-2">Inicie conversas diretas com seus contatos.</p>
            </div>
        </div>

        <footer class="absolute bottom-0 left-0 right-0 p-4 bg-black/50 border-t border-cyan-500/20 flex justify-between items-center">
            <div id="user-profile-footer" class="flex items-center gap-3 cursor-pointer group">
                <img id="user-avatar-home" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-cyan-400 group-hover:border-white transition-all">
                <div>
                    <p id="user-name-home" class="font-bold text-white group-hover:text-cyan-300 transition-all">Carregando...</p>
                    <p id="user-region-home" class="text-xs text-gray-400">...</p>
                </div>
            </div>
            <button class="font-bold py-2 px-5 rounded-md text-white bg-purple-600 border border-purple-400 neon-premium-glow">
                <i class="fas fa-star mr-2"></i>ATIVAR PREMIUM
            </button>
        </footer>
    </div>


  <!-- Scanning Screen (Simplified) -->
  <div id="entry-screen" class="hidden w-full h-full flex-col items-center justify-center p-4 text-center relative z-10">
    <div id="scanning-content" class="flex-col items-center justify-center space-y-4">
      <div class="w-16 h-16 border-4 border-dashed border-cyan-500 rounded-full animate-spin"></div>
      <p class="text-xl text-cyan-400 tracking-wider">BUSCANDO CONEXÃO REAL...</p>
    </div>
  </div>

  <!-- Chat Screen (1-on-1 Random) -->
  <main id="chat-screen" class="hidden w-full h-screen p-4 flex gap-4 font-orbitron bg-black relative overflow-hidden z-10">
    <!-- Left Sidebar -->
    <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
      <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center border-b border-cyan-500/30 pb-2">STATUS</h2>
      <div class="flex-grow flex flex-col justify-center items-center text-center">
        <div class="relative flex items-center justify-center w-24 h-24 mb-4">
          <div class="absolute inset-0 bg-green-500/50 rounded-full animate-ping"></div>
          <img id="my-avatar-chat" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" class="w-20 h-20 rounded-full border-2 border-cyan-300 z-10">
        </div>
        <p class="text-2xl font-bold text-green-400 neon-text-green">ONLINE</p>
        <p class="text-sm text-gray-400">Você está conectado ao Vazio.</p>
      </div>
       <div class="text-center border-t border-cyan-500/30 pt-4 space-y-3">
          <div>
            <p id="online-users" class="text-lg text-white">1</p>
            <p class="text-sm text-cyan-400 neon-text-cyan flex items-center justify-center gap-2">
              <span class="w-3 h-3 bg-green-400 rounded-full pulse-dot"></span>
              HUMANOS CONECTADOS
            </p>
          </div>
          <button id="random-chat-exit-btn" class="w-full p-2 bg-red-800/50 hover:bg-red-700/50 border border-red-500/50 rounded-md transition-colors text-sm">
            <i class="fas fa-sign-out-alt mr-2"></i>SAIR DA SALA
          </button>
      </div>
    </aside>

    <!-- Center Chat -->
    <section class="w-1/2 h-full flex flex-col bg-black/50 border border-gray-700/50 rounded-lg overflow-hidden z-10">
        <header class="p-3 border-b border-gray-700/50 text-center flex items-center gap-4 justify-center">
          <img id="partner-avatar-chat" src="https://i.pravatar.cc/150?u=a042581f4e29026704e" class="w-10 h-10 rounded-full border-2 border-gray-500">
          <div>
            <h3 id="partner-name" class="font-bold text-lg text-white">CONEXÃO ESTABELECIDA</h3>
            <p id="partner-info" class="text-xs text-gray-400">Você está conversando com um estranho.</p>
          </div>
        </header>
        <div id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
          <!-- Messages will be injected here -->
        </div>
        <footer class="p-3 border-t border-gray-700/50 bg-black/50">
          <form id="message-form" class="flex items-center gap-3">
            <input type="text" id="message-input" placeholder="Digite no Vazio..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
            <button type="submit" id="send-btn" class="bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-700 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-md transition-colors">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </footer>
    </section>

    <!-- Right Sidebar -->
    <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
      <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center border-b border-cyan-500/30 pb-2">ÁREA VIP</h2>
      <div class="flex-grow flex flex-col justify-center gap-4">
          <button class="w-full text-center p-4 border-2 border-cyan-400 rounded-md neon-button-glow hover:bg-cyan-400 hover:text-black transition-all">
            <p class="font-bold text-lg">ATIVAR FILTRO DE GÊNERO</p>
            <p class="text-xs font-sans">REQUER ASSINATURA VIP</p>
          </button>
          <button class="w-full text-center p-4 border-2 border-purple-500 text-purple-400 rounded-md neon-button-glow hover:bg-purple-500 hover:text-black transition-all">
            <p class="font-bold text-lg">TURBO MATCH</p>
            <p class="text-xs font-sans">CONEXÃO IMEDIATA</p>
          </button>
      </div>
      <button id="next-btn" class="w-full p-3 bg-gray-700 hover:bg-gray-600 border border-gray-500 rounded-md transition-colors">
        PRÓXIMO
      </button>
    </aside>
  </main>

    <!-- Global Chat Screen -->
    <main id="global-chat-screen" class="hidden w-full h-screen p-4 flex gap-4 font-orbitron bg-black relative overflow-hidden z-10">
        <!-- Left Sidebar - Online Users -->
        <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-2">
                 <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center">ONLINE</h2>
                 <button id="global-chat-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </button>
            </div>
            <div id="global-online-users-list" class="flex-grow overflow-y-auto space-y-1 no-scrollbar pr-2">
                <!-- User list will be populated here -->
            </div>
        </aside>

        <!-- Center Chat -->
        <section class="w-3/4 h-full flex flex-col bg-black/50 border border-gray-700/50 rounded-lg overflow-hidden z-10">
            <header class="p-3 border-b border-gray-700/50 text-center">
                <h3 class="font-bold text-lg text-white neon-text-cyan">CHAT GLOBAL</h3>
                <p class="text-xs text-gray-400">Todos os humanos conectados no Vazio.</p>
            </header>
            <div id="global-chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
                <!-- Global messages will be injected here -->
            </div>
            <footer class="p-3 border-t border-gray-700/50 bg-black/50">
                <form id="global-message-form" class="flex items-center gap-3">
                    <input type="text" id="global-message-input" placeholder="Converse com o mundo..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
                    <button type="button" id="record-audio-btn" class="text-cyan-400 hover:text-white text-xl px-3 transition-colors">
                      <i class="fas fa-microphone"></i>
                    </button>
                    <button type="submit" id="global-send-btn" class="bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-700 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </footer>
        </section>
    </main>
    
    <!-- Contacts Screen -->
    <div id="contacts-screen" class="hidden w-full h-full flex flex-col justify-center items-center p-4 relative z-10">
        <div class="w-full max-w-2xl h-4/5 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 neon-border-cyan flex flex-col">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-3 mb-4">
                <h2 class="text-3xl font-bold text-cyan-400 neon-text-cyan">CONTATOS</h2>
                <button id="contacts-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                   <i class="fas fa-times fa-lg"></i>
               </button>
           </div>
           <div id="contacts-list" class="flex-grow overflow-y-auto space-y-2 no-scrollbar pr-2">
               <!-- Contacts list will be populated here -->
           </div>
        </div>
    </div>

    <!-- Private Chat Screen -->
    <main id="private-chat-screen" class="hidden w-full h-screen p-4 flex justify-center items-center font-orbitron bg-black relative overflow-hidden z-10">
        <section class="w-full max-w-3xl h-5/6 flex flex-col bg-black/50 border border-cyan-500/50 neon-border-cyan rounded-lg overflow-hidden z-10">
            <header class="p-3 border-b border-cyan-500/50 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img id="private-chat-partner-avatar" src="https://i.pravatar.cc/150?u=a042581f4e29026704e" class="w-10 h-10 rounded-full border-2 border-gray-500">
                    <div>
                      <h3 id="private-chat-partner-name" class="font-bold text-lg text-white">Carregando...</h3>
                      <p id="private-chat-partner-status" class="text-xs text-red-500 neon-text-red">Offline</p>
                    </div>
                </div>
                <button id="private-chat-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </button>
            </header>
            <div id="private-chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
                <!-- Private messages will be injected here -->
            </div>
            <footer class="p-3 border-t border-cyan-500/50 bg-black/50">
                <form id="private-message-form" class="flex items-center gap-3">
                    <input type="text" id="private-message-input" placeholder="Envie uma mensagem privada..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
                    <button type="submit" id="private-send-btn" class="bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </footer>
        </section>
    </main>


<script>
document.addEventListener('DOMContentLoaded', () => {

  // Iframe check to prevent disallowed_useragent error with Google Auth
  try {
    if (window.self !== window.top) {
        document.body.innerHTML = `<div class="bg-black text-red-500 w-screen h-screen flex items-center justify-center p-4 text-center"><h1 class="text-2xl font-bold">ERRO: Este aplicativo não pode ser executado em um iframe.</h1></div>`;
        return;
    }
  } catch (e) {
    console.warn("Iframe check failed, might be due to cross-origin policies. Proceeding with caution.");
  }


  // ---=== FIREBASE CONFIGURATION ===---
  const firebaseConfig = {
    apiKey: "AIzaSyCJY8KnCAmegTJKgxk8Vb0fdDU64JV-zbU",
    authDomain: "meuchatreal.firebaseapp.com",
    databaseURL: "https://meuchatreal-default-rtdb.firebaseio.com",
    projectId: "meuchatreal",
    storageBucket: "meuchatreal.appspot.com",
    messagingSenderId: "271430524108",
    appId: "1:271430524108:web:e23b8c36a188f150467669"
  };

  // ---=== INITIALIZATION ===---
  let db, auth, storage;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    auth = firebase.auth();
    storage = firebase.storage();
  } catch (e) {
    console.error("Firebase initialization failed.", e);
    document.body.innerHTML = `<div class="bg-black text-red-500 w-screen h-screen flex items-center justify-center p-4 text-center"><h1 class="text-2xl font-bold">ERRO CRÍTICO: Falha na inicialização do Firebase. Verifique a configuração.</h1></div>`;
    return;
  }

  // ---=== DOM ELEMENTS ===---
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingMsg = document.getElementById('loading-msg');
  const loginScreen = document.getElementById('login-screen');
  const profileModal = document.getElementById('profile-modal');
  const homeScreen = document.getElementById('home-screen');
  const entryScreen = document.getElementById('entry-screen');
  const chatScreen = document.getElementById('chat-screen');
  const globalChatScreen = document.getElementById('global-chat-screen');
  const contactsScreen = document.getElementById('contacts-screen');
  const privateChatScreen = document.getElementById('private-chat-screen');
  
  const loginForm = document.getElementById('login-form');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const signupBtn = document.getElementById('signup-btn');
  const googleSigninBtn = document.getElementById('google-signin-btn');
  const authErrorEl = document.getElementById('auth-error');
  const randomChatExitBtn = document.getElementById('random-chat-exit-btn');

  const profileForm = document.getElementById('profile-form');
  const usernameInput = document.getElementById('username-input');
  const genderSelect = document.getElementById('gender-select');
  const regionSelect = document.getElementById('region-select');
  const interestsInput = document.getElementById('interests-input');
  const avatarInput = document.getElementById('avatar-input');
  const saveFullProfileBtn = document.getElementById('save-full-profile-btn');
  const fullProfileErrorEl = document.getElementById('full-profile-error');

  const userProfileFooter = document.getElementById('user-profile-footer');
  const userAvatarHome = document.getElementById('user-avatar-home');
  const userNameHome = document.getElementById('user-name-home');
  const userRegionHome = document.getElementById('user-region-home');

  const matchBtn = document.getElementById('match-btn');
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');
  const chatContainer = document.getElementById('chat-container');
  const partnerNameEl = document.getElementById('partner-name');
  const partnerInfoEl = document.getElementById('partner-info');
  const myAvatarChatEl = document.getElementById('my-avatar-chat');
  const partnerAvatarChatEl = document.getElementById('partner-avatar-chat');
  const nextBtn = document.getElementById('next-btn');
  const onlineUsersEl = document.getElementById('online-users');

  // Global Chat Elements
  const globalChatCard = document.getElementById('global-chat-card');
  const globalChatBackBtn = document.getElementById('global-chat-back-btn');
  const globalOnlineUsersList = document.getElementById('global-online-users-list');
  const globalChatContainer = document.getElementById('global-chat-container');
  const globalMessageForm = document.getElementById('global-message-form');
  const globalMessageInput = document.getElementById('global-message-input');
  const recordAudioBtn = document.getElementById('record-audio-btn');
  
  // Private Chat & Contacts Elements
  const privateChatCard = document.getElementById('private-chat-card');
  const privateChatNotification = document.getElementById('private-chat-notification');
  const contactsBackBtn = document.getElementById('contacts-back-btn');
  const contactsList = document.getElementById('contacts-list');
  const privateChatBackBtn = document.getElementById('private-chat-back-btn');
  const privateChatPartnerAvatar = document.getElementById('private-chat-partner-avatar');
  const privateChatPartnerName = document.getElementById('private-chat-partner-name');
  const privateChatPartnerStatus = document.getElementById('private-chat-partner-status');
  const privateChatContainer = document.getElementById('private-chat-container');
  const privateMessageForm = document.getElementById('private-message-form');
  const privateMessageInput = document.getElementById('private-message-input');


  // ---=== STATE VARIABLES ===---
  let currentUser = null;
  let currentUserProfile = null;
  // Matchmaking State
  let sessionId = null;
  let chatRoomId = null;
  let partnerId = null;
  let roomRef = null;
  let messagesListener = null;
  let roomValueListener = null;
  let chatParticipantData = {};
  // Global Chat State
  let globalMessagesListener = null;
  let globalOnlineListener = null;
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  // Private Chat State
  let currentPrivateChatFriend = null;
  let privateChatRoomId = null;
  let privateMessagesListener = null;
  let contactsListener = null;
  let presenceListener = null;
  let unreadListener = null;

  // ---=== UI HELPER FUNCTIONS ===---
  const setLoadingState = (isLoading, message = '') => {
      if (isLoading) {
          loadingMsg.textContent = message;
          loadingOverlay.classList.remove('hidden');
          loadingOverlay.classList.add('flex');
      } else {
          loadingOverlay.classList.add('hidden');
          loadingOverlay.classList.remove('flex');
      }
  };

  const showView = (view) => {
    document.querySelectorAll('main, div[id$="-screen"]').forEach(el => {
        el.classList.add('hidden');
        el.style.display = 'none';
    });
    const viewMap = {
      login: loginScreen, home: homeScreen, scanning: entryScreen,
      chat: chatScreen, 'global-chat': globalChatScreen,
      'contacts': contactsScreen, 'private-chat': privateChatScreen,
    };
    if(viewMap[view]) {
      viewMap[view].classList.remove('hidden');
      viewMap[view].style.display = 'flex';
    }
  };
  
  const showProfileModal = (show) => {
    if(show){
      profileModal.classList.remove('hidden');
      profileModal.style.display = 'flex';
    } else {
      profileModal.classList.add('hidden');
      profileModal.style.display = 'none';
    }
  };
  
  const populateRegions = () => {
    const states = ["Acre", "Alagoas", "Amapá", "Amazonas", "Bahia", "Ceará", "Distrito Federal", "Espírito Santo", "Goiás", "Maranhão", "Mato Grosso", "Mato Grosso do Sul", "Minas Gerais", "Pará", "Paraíba", "Paraná", "Pernambuco", "Piauí", "Rio de Janeiro", "Rio Grande do Norte", "Rio Grande do Sul", "Rondônia", "Roraima", "Santa Catarina", "São Paulo", "Sergipe", "Tocantins"];
    regionSelect.innerHTML = '<option value="">Selecione seu estado...</option>';
    states.forEach(state => {
      const option = document.createElement('option');
      option.value = state;
      option.textContent = state;
      regionSelect.appendChild(option);
    });
  };
  populateRegions();
  
  const populateHomePage = (profile) => {
      if (!profile) return;
      userAvatarHome.src = profile.avatar || 'https://i.pravatar.cc/150?u=a042581f4e29026704d';
      userNameHome.textContent = profile.username;
      userRegionHome.textContent = profile.region;
  };
  
  // ---=== AUTHENTICATION & PROFILE LOGIC ===---
  const handleAuthError = (error) => {
    setLoadingState(false);
    let message = 'Ocorreu um erro. Tente novamente.';
    if(error.code) {
        switch (error.code) {
            case 'auth/user-not-found':
            case 'auth/wrong-password': message = 'Email ou senha inválidos.'; break;
            case 'auth/email-already-in-use': message = 'Este email já está em uso.'; break;
            case 'auth/weak-password': message = 'A senha deve ter pelo menos 6 caracteres.'; break;
            case 'auth/account-exists-with-different-credential':
                message = 'Uma conta já existe com este email. Tente logar com o Google.'; break;
        }
    }
    authErrorEl.textContent = message;
    console.error("Auth Error:", error);
  };
  
  const managePresence = (user) => {
    const userStatusRef = db.ref(`/presence/${user.uid}`);
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => {
      if (snap.val() === true) {
        userStatusRef.set(true);
        userStatusRef.onDisconnect().remove();
      }
    });
  };

  const listenForUnreadMessages = (user) => {
      const unreadRef = db.ref(`users/${user.uid}/unread_messages`);
      if (unreadListener) unreadRef.off('value', unreadListener);
      unreadListener = unreadRef.on('value', snapshot => {
          if (snapshot.exists()) {
              privateChatNotification.classList.remove('hidden');
          } else {
              privateChatNotification.classList.add('hidden');
          }
      });
  };
  
  const checkUserProfile = async (user) => {
    const userRef = db.ref(`users/${user.uid}`);
    const snapshot = await userRef.once('value');
    let profile = snapshot.val();
    
    // Fetch contacts and merge into profile object
    const contactsSnapshot = await db.ref(`users/${user.uid}/contacts`).once('value');
    profile = { ...profile, contacts: contactsSnapshot.val() || {} };
    currentUserProfile = profile;

    const isProfileComplete = profile && profile.username && profile.gender && profile.region && profile.interests && profile.avatar;

    if (isProfileComplete) {
      populateHomePage(profile);
      managePresence(user);
      listenForUnreadMessages(user);
      showView('home');
    } else {
      showProfileModal(true);
    }
    setLoadingState(false);
  };
  
  setLoadingState(true, 'Verificando login...');
  auth.getRedirectResult().catch(handleAuthError);

  auth.onAuthStateChanged((user) => {
    console.log("Auth state changed:", user ? `Logged in as ${user.uid}` : 'Logged out');
    if (user) {
      currentUser = user;
      checkUserProfile(user);
    } else {
      currentUser = null;
      currentUserProfile = null;
      // Detach all listeners on logout
      if (unreadListener) db.ref(`users/${currentUser?.uid}/unread_messages`).off('value', unreadListener);
      showView('login');
      setLoadingState(false);
    }
  });

  // ---=== RANDOM CHAT (MATCHMAKING) LOGIC ===---
  const findPartner = async () => { /* ... (code unchanged) ... */ };
  const startChat = async (pId) => { /* ... (code unchanged) ... */ };
  const sendMessage = (text) => { /* ... (code unchanged) ... */ };
  const resetRandomChatState = () => {
    console.log("Resetting random chat state...");
    if (roomRef) {
        if (messagesListener) roomRef.child('messages').off('child_added', messagesListener);
        if (roomValueListener) roomRef.off('value', roomValueListener);
        roomRef.remove().catch(e => console.warn("Error removing room:", e.message));
        roomRef.onDisconnect().cancel();
    }
    if (sessionId) {
        db.ref(`queue/${sessionId}`).remove().catch(e => console.warn("Error removing from queue:", e.message));
        sessionId = null;
    }
    chatRoomId = null; partnerId = null; roomRef = null; messagesListener = null; roomValueListener = null; chatParticipantData = {};
    chatContainer.innerHTML = '';
    partnerNameEl.textContent = 'CONEXÃO ESTABELECIDA'; partnerInfoEl.textContent = 'Você está conversando com um estranho.';
  };

  // ---=== GLOBAL CHAT LOGIC ===---
  const enterGlobalChat = () => {
    if (!currentUser || !currentUserProfile) return;
    const onlineRef = db.ref('global_online');
    const userStatusRef = onlineRef.child(currentUser.uid);
    userStatusRef.set({ username: currentUserProfile.username, avatar: currentUserProfile.avatar });
    userStatusRef.onDisconnect().remove();

    globalOnlineListener = onlineRef.on('value', snapshot => updateGlobalOnlineList(snapshot.val() || {}));
    
    const messagesRef = db.ref('global_messages').limitToLast(50);
    globalMessagesListener = messagesRef.on('child_added', snapshot => addGlobalMessageToUI(snapshot.val()));
    
    showView('global-chat');
  };

  const leaveGlobalChat = () => {
    if (globalMessagesListener) db.ref('global_messages').off('child_added', globalMessagesListener);
    if (globalOnlineListener) db.ref('global_online').off('value', globalOnlineListener);
    db.ref(`global_online/${currentUser.uid}`).remove();
    showView('home');
  };
  
  const updateGlobalOnlineList = (users) => {
      globalOnlineUsersList.innerHTML = '';
      Object.entries(users).forEach(([uid, user]) => {
          if (uid === currentUser.uid) return;
          const isFriend = currentUserProfile.contacts && currentUserProfile.contacts[uid];
          const userEl = document.createElement('div');
          userEl.className = 'flex items-center justify-between gap-3 p-2 rounded-md hover:bg-cyan-500/10';
          userEl.innerHTML = `
              <div class="flex items-center gap-3">
                <img src="${user.avatar}" alt="${user.username}" class="w-8 h-8 rounded-full">
                <span class="text-sm font-medium text-white hover:text-cyan-300 hover:neon-text-cyan transition-all">${user.username}</span>
              </div>
              <button data-friend-id="${uid}" class="add-friend-btn text-cyan-400 hover:text-white disabled:text-green-500 disabled:cursor-not-allowed" ${isFriend ? 'disabled' : ''}>
                <i class="fas ${isFriend ? 'fa-check' : 'fa-plus'}"></i>
              </button>
          `;
          globalOnlineUsersList.appendChild(userEl);
      });
  };

  const addGlobalMessageToUI = (message) => { /* ... (code unchanged) ... */ };
  const sendGlobalMessage = (text, type = 'text') => { /* ... (code unchanged) ... */ };
  const toggleAudioRecording = async () => { /* ... (code unchanged) ... */ };
  const uploadAudio = (blob) => { /* ... (code unchanged) ... */ };
  
  const addFriend = async (friendId) => {
      if (!currentUser || !friendId) return;
      const updates = {};
      updates[`/users/${currentUser.uid}/contacts/${friendId}`] = true;
      updates[`/users/${friendId}/contacts/${currentUser.uid}`] = true;
      await db.ref().update(updates);
      // Update local profile and UI
      currentUserProfile.contacts[friendId] = true;
      const button = globalOnlineUsersList.querySelector(`button[data-friend-id="${friendId}"]`);
      if (button) {
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-check"></i>';
      }
  };

  // ---=== PRIVATE CHAT & CONTACTS LOGIC ===---
  const enterContactsScreen = () => {
      showView('contacts');
      if (contactsListener) db.ref(`users/${currentUser.uid}/contacts`).off('value', contactsListener);
      
      contactsListener = db.ref(`users/${currentUser.uid}/contacts`).on('value', async (contactSnapshot) => {
          const contactIds = contactSnapshot.val() ? Object.keys(contactSnapshot.val()) : [];
          if (presenceListener) db.ref('presence').off('value', presenceListener);
          
          presenceListener = db.ref('presence').on('value', async (presenceSnapshot) => {
              const onlineUids = presenceSnapshot.val() || {};
              contactsList.innerHTML = '';
              if (contactIds.length === 0) {
                contactsList.innerHTML = `<p class="text-gray-500 text-center mt-8">Adicione amigos no Chat Global para começar.</p>`;
                return;
              }
              for (const friendId of contactIds) {
                  const userSnap = await db.ref(`users/${friendId}`).once('value');
                  const friendProfile = userSnap.val();
                  if (!friendProfile) continue;

                  const isOnline = onlineUids[friendId] === true;
                  const contactEl = document.createElement('div');
                  contactEl.className = 'flex items-center justify-between gap-4 p-3 rounded-lg hover:bg-cyan-500/20 cursor-pointer transition-colors';
                  contactEl.dataset.friendId = friendId;
                  contactEl.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${friendProfile.avatar}" class="w-12 h-12 rounded-full">
                        <div>
                            <p class="font-bold text-white text-lg">${friendProfile.username}</p>
                            <p class="text-xs ${isOnline ? 'text-green-400 neon-text-green' : 'text-gray-500'}">${isOnline ? 'Online' : 'Offline'}</p>
                        </div>
                    </div>
                    <i class="fas fa-comment-dots text-cyan-400"></i>
                  `;
                  contactEl.addEventListener('click', () => startPrivateChat(friendId, friendProfile));
                  contactsList.appendChild(contactEl);
              }
          });
      });
  };

  const leaveContactsScreen = () => {
    if (contactsListener) db.ref(`users/${currentUser.uid}/contacts`).off('value', contactsListener);
    if (presenceListener) db.ref('presence').off('value', presenceListener);
  };

  const startPrivateChat = (friendId, friendProfile) => {
      leaveContactsScreen();
      currentPrivateChatFriend = { id: friendId, ...friendProfile };
      
      const ids = [currentUser.uid, friendId].sort();
      privateChatRoomId = ids.join('_');
      
      privateChatPartnerAvatar.src = friendProfile.avatar;
      privateChatPartnerName.textContent = friendProfile.username;

      // Listen for friend's presence
      const friendStatusRef = db.ref(`presence/${friendId}`);
      presenceListener = friendStatusRef.on('value', snap => {
          if (snap.exists()) {
              privateChatPartnerStatus.textContent = 'Online';
              privateChatPartnerStatus.className = 'text-xs text-green-400 neon-text-green';
          } else {
              privateChatPartnerStatus.textContent = 'Offline';
              privateChatPartnerStatus.className = 'text-xs text-red-500 neon-text-red';
          }
      });
      
      // Clear unread messages flag for this chat
      db.ref(`users/${currentUser.uid}/unread_messages/${privateChatRoomId}`).remove();
      
      privateChatContainer.innerHTML = '';
      const messagesRef = db.ref(`private_messages/${privateChatRoomId}/messages`).limitToLast(100);
      privateMessagesListener = messagesRef.on('child_added', snap => addPrivateMessageToUI(snap.val()));

      showView('private-chat');
  };

  const leavePrivateChat = () => {
      if (privateMessagesListener) db.ref(`private_messages/${privateChatRoomId}/messages`).off('child_added', privateMessagesListener);
      if (presenceListener) db.ref(`presence/${currentPrivateChatFriend.id}`).off('value', presenceListener);
      currentPrivateChatFriend = null;
      privateChatRoomId = null;
      enterContactsScreen();
  };

  const addPrivateMessageToUI = (message) => {
    if (!message || !currentUser) return;
    const isMe = message.senderId === currentUser.uid;
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex flex-col fade-in ${isMe ? 'items-end' : 'items-start'}`;
    messageDiv.innerHTML = `
      <div class="px-4 py-2 rounded-lg ${isMe ? 'bg-cyan-800' : 'bg-gray-700'} max-w-md">
        <p class="text-sm break-words">${message.text}</p>
      </div>`;
    privateChatContainer.appendChild(messageDiv);
    privateChatContainer.scrollTop = privateChatContainer.scrollHeight;
  };
  
  const sendPrivateMessage = (text) => {
      if (text.trim() === '' || !privateChatRoomId || !currentPrivateChatFriend) return;
      const messageData = {
          senderId: currentUser.uid,
          text: text,
          timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref(`private_messages/${privateChatRoomId}/messages`).push(messageData);
      db.ref(`users/${currentPrivateChatFriend.id}/unread_messages/${privateChatRoomId}`).set(true);
  };


  // ---=== EVENT LISTENERS ===---
  // ... (login, signup, google signin, profile save listeners unchanged) ...
  loginForm.addEventListener('submit', (e) => e.preventDefault());
  loginBtn.addEventListener('click', () => { authErrorEl.textContent = ''; setLoadingState(true, 'Autenticando...'); auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value).catch(handleAuthError); });
  signupBtn.addEventListener('click', () => { authErrorEl.textContent = ''; setLoadingState(true, 'Criando conta...'); auth.createUserWithEmailAndPassword(emailInput.value.trim(), passwordInput.value).catch(handleAuthError); });
  googleSigninBtn.addEventListener('click', () => { authErrorEl.textContent = ''; const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithRedirect(provider).catch(handleAuthError); });
  profileForm.addEventListener('submit', (e) => { e.preventDefault(); /* ... profile save logic ... */ });
  userProfileFooter.addEventListener('click', () => { /* ... show profile modal logic ... */ });

  // Random Chat Navigation
  randomChatExitBtn.addEventListener('click', () => { resetRandomChatState(); showView('home'); });
  matchBtn.addEventListener('click', findPartner);
  nextBtn.addEventListener('click', () => { resetRandomChatState(); findPartner(); });
  messageForm.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(messageInput.value); messageInput.value = ''; });

  // Global Chat Navigation & Events
  globalChatCard.addEventListener('click', enterGlobalChat);
  globalChatBackBtn.addEventListener('click', leaveGlobalChat);
  globalMessageForm.addEventListener('submit', (e) => { e.preventDefault(); sendGlobalMessage(globalMessageInput.value, 'text'); globalMessageInput.value = ''; });
  recordAudioBtn.addEventListener('click', toggleAudioRecording);
  globalOnlineUsersList.addEventListener('click', (e) => {
      const button = e.target.closest('.add-friend-btn');
      if (button && !button.disabled) {
          addFriend(button.dataset.friendId);
      }
  });

  // Private Chat & Contacts Navigation
  privateChatCard.addEventListener('click', enterContactsScreen);
  contactsBackBtn.addEventListener('click', () => { leaveContactsScreen(); showView('home'); });
  privateChatBackBtn.addEventListener('click', leavePrivateChat);
  privateMessageForm.addEventListener('submit', (e) => {
      e.preventDefault();
      sendPrivateMessage(privateMessageInput.value);
      privateMessageInput.value = '';
  });

  window.addEventListener('beforeunload', () => {
      if(currentUser){
        db.ref(`presence/${currentUser.uid}`).remove();
        db.ref(`global_online/${currentUser.uid}`).remove();
        resetRandomChatState();
      }
  });
});
</script>
<!-- Unchanged parts of the script are commented for brevity -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ... existing code from line 238 up ...

    const findPartner = async () => {
    if (!currentUser) return;
    console.log("Looking for a partner...");
    showView('scanning');
    
    const queueRef = db.ref('queue');
    const myQueueEntryRef = queueRef.push();
    sessionId = myQueueEntryRef.key;

    myQueueEntryRef.onDisconnect().remove();
    await myQueueEntryRef.set({
      userId: currentUser.uid,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    const onPartnerFound = (partnerSessionId, partnerUserId) => {
        const sortedIds = [currentUser.uid, partnerUserId].sort();
        chatRoomId = `room_${sortedIds[0]}_${sortedIds[1]}`;
        
        const roomMembers = { [currentUser.uid]: true, [partnerUserId]: true };
        const roomData = { members: roomMembers, createdAt: firebase.database.ServerValue.TIMESTAMP };

        roomRef = db.ref(`rooms/${chatRoomId}`);
        roomRef.set(roomData).then(() => {
          db.ref(`queue/${partnerSessionId}`).remove();
          myQueueEntryRef.onDisconnect().cancel();
          myQueueEntryRef.remove();
          sessionId = null;
          startChat(partnerUserId);
        }).catch(err => {
            console.error("Failed to create room:", err);
            resetRandomChatState();
            showView('home');
        });
    };

    const queueListener = queueRef.on('value', snapshot => {
        const queue = snapshot.val();
        if (!queue) return;
        const otherUsers = Object.entries(queue).filter(([key, val]) => val.userId !== currentUser.uid);
        if (otherUsers.length > 0) {
            queueRef.off('value', queueListener);
            const [partnerSessionId, partnerData] = otherUsers[0];
            onPartnerFound(partnerSessionId, partnerData.userId);
        }
    });

    setTimeout(() => {
        queueRef.off('value', queueListener);
        if (!chatRoomId && sessionId) {
            console.log("Matchmaking timed out.");
            alert("Não foi possível encontrar um parceiro. Tente novamente.");
            db.ref(`queue/${sessionId}`).remove();
            sessionId = null;
            showView('home');
        }
    }, 30000);
  };

  const startChat = async (pId) => {
    if (!currentUser || !chatRoomId) return;
    partnerId = pId;
    
    try {
        const partnerProfileSnapshot = await db.ref(`users/${partnerId}`).once('value');
        chatParticipantData[currentUser.uid] = currentUserProfile;
        chatParticipantData[partnerId] = partnerProfileSnapshot.val() || { username: 'Estranho', region: 'Desconhecida', avatar: '' };
    } catch (error) {
        console.error("Failed to fetch profiles:", error);
    }
    
    myAvatarChatEl.src = chatParticipantData[currentUser.uid].avatar;
    partnerAvatarChatEl.src = chatParticipantData[partnerId].avatar;
    partnerNameEl.textContent = chatParticipantData[partnerId].username;
    partnerInfoEl.textContent = `Conectado de ${chatParticipantData[partnerId].region}`;

    roomRef = db.ref(`rooms/${chatRoomId}`);
    roomRef.onDisconnect().remove();
    showView('chat');
    
    messagesListener = roomRef.child('messages').on('child_added', (snapshot) => addMessageToUI(snapshot.val()));
    
    roomValueListener = roomRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!chatRoomId) { return; }
      if (!data || !data.members || !data.members[partnerId]) {
        roomRef.off('value', roomValueListener);
        setLoadingState(true, 'O estranho saiu do Vazio...');
        setTimeout(() => {
          setLoadingState(false);
          resetRandomChatState();
          findPartner();
        }, 2000);
      } else {
         onlineUsersEl.textContent = Object.keys(data.members).length;
      }
    });
  };

  const sendMessage = (text) => {
    if (text.trim() === '' || !roomRef || !currentUser) return;
    roomRef.child('messages').push({
      senderId: currentUser.uid,
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
  };

  const addMessageToUI = (message) => {
    if (!message || !message.senderId || !currentUser) return;
    const isMe = message.senderId === currentUser.uid;
    const senderUsername = chatParticipantData[message.senderId]?.username || 'Estranho';
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex flex-col fade-in ${isMe ? 'items-end' : 'items-start'}`;
    messageDiv.innerHTML = `<div class="max-w-md"><p class="text-xs mb-1 ${isMe ? 'text-right' : 'text-left'} text-cyan-400">${senderUsername}</p><div class="px-4 py-2 rounded-lg ${isMe ? 'bg-cyan-800' : 'bg-gray-700'}"><p class="text-sm break-words">${message.text}</p></div></div>`;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  const addGlobalMessageToUI = (message) => {
      if (!message || !currentUser) return;
      const isMe = message.senderId === currentUser.uid;
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex gap-3 my-2 ${isMe ? 'justify-end' : 'justify-start'}`;
      let contentHTML = message.type === 'audio' ? `<audio controls src="${message.text}" class="w-64"></audio>` : `<p class="text-sm break-words">${message.text}</p>`;
      messageDiv.innerHTML = `
        ${!isMe ? `<img src="${message.avatar}" class="w-8 h-8 rounded-full self-end">` : ''}
        <div class="max-w-md">
            <p class="text-xs mb-1 ${isMe ? 'text-right' : 'text-left'} text-cyan-400">${message.username}</p>
            <div class="px-4 py-2 rounded-lg ${isMe ? 'bg-green-800/50 border border-green-500/50 neon-border-green' : 'bg-gray-700'}">${contentHTML}</div>
        </div>
        ${isMe ? `<img src="${message.avatar}" class="w-8 h-8 rounded-full self-end">` : ''}`;
      globalChatContainer.appendChild(messageDiv);
      globalChatContainer.scrollTop = globalChatContainer.scrollHeight;
  };
  
  const sendGlobalMessage = (text, type = 'text') => {
      if ((!text || text.trim() === '') || !currentUserProfile) return;
      db.ref('global_messages').push({ senderId: currentUser.uid, username: currentUserProfile.username, avatar: currentUserProfile.avatar, text: text, type: type, timestamp: firebase.database.ServerValue.TIMESTAMP });
  };

  const toggleAudioRecording = async () => {
    if (isRecording) {
      mediaRecorder.stop();
      recordAudioBtn.classList.remove('recording-active');
      isRecording = false;
    } else {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordAudioBtn.classList.add('recording-active');
        isRecording = true;
        mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
        mediaRecorder.addEventListener("stop", () => {
          const audioBlob = new Blob(audioChunks);
          uploadAudio(audioBlob);
          audioChunks = [];
          stream.getTracks().forEach(track => track.stop());
        });
      } catch (err) {
        console.error("Error accessing microphone:", err);
        alert("Não foi possível acessar o microfone.");
      }
    }
  };

  const uploadAudio = (blob) => {
    const fileName = `global_audio/${currentUser.uid}_${Date.now()}.webm`;
    const uploadTask = storage.ref(fileName).put(blob);
    setLoadingState(true, 'Enviando áudio...');
    uploadTask.on('state_changed', null, 
      (error) => { setLoadingState(false); alert("Falha no upload do áudio."); }, 
      () => { uploadTask.snapshot.ref.getDownloadURL().then((url) => { sendGlobalMessage(url, 'audio'); setLoadingState(false); }); }
    );
  };
    
  profileForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const profileData = { username: usernameInput.value.trim(), gender: genderSelect.value, region: regionSelect.value, interests: interestsInput.value.trim(), avatar: avatarInput.value.trim() };
    if (profileData.username.length < 3 || !profileData.gender || !profileData.region || !profileData.avatar) { fullProfileErrorEl.textContent = 'Preencha todos os campos corretamente.'; return; }
    fullProfileErrorEl.textContent = '';
    setLoadingState(true, 'Salvando perfil...');
    db.ref(`users/${currentUser.uid}`).update(profileData).then(() => {
        currentUserProfile = {...currentUserProfile, ...profileData};
        populateHomePage(currentUserProfile);
        showProfileModal(false);
        showView('home');
      }).catch((e) => fullProfileErrorEl.textContent = 'Erro ao salvar.').finally(() => setLoadingState(false));
  });

  userProfileFooter.addEventListener('click', () => {
    if(!currentUserProfile) return;
    usernameInput.value = currentUserProfile.username || '';
    genderSelect.value = currentUserProfile.gender || '';
    regionSelect.value = currentUserProfile.region || '';
    interestsInput.value = currentUserProfile.interests || '';
    avatarInput.value = currentUserProfile.avatar || '';
    showProfileModal(true);
  });
    // ... rest of the event listeners ...
});
</script>

</body>
</html>
