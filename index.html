<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VOID CHAT</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDKs CDN (Compat Version 9.6.1) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  
  <!-- Font Awesome CDN for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Google Fonts: Orbitron -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      overflow: hidden;
    }
    .neon-border-cyan {
      box-shadow: 0 0 3px rgba(0, 255, 255, 0.8), 0 0 5px rgba(0, 255, 255, 0.6), 0 0 10px rgba(0, 255, 255, 0.4);
    }
    .neon-border-green {
      box-shadow: 0 0 3px rgba(57, 255, 20, 0.8), 0 0 5px rgba(57, 255, 20, 0.6), 0 0 10px rgba(57, 255, 20, 0.4);
    }
    .neon-border-gold {
      box-shadow: 0 0 3px rgba(255, 215, 0, 0.8), 0 0 5px rgba(255, 215, 0, 0.6), 0 0 10px rgba(255, 215, 0, 0.4);
    }
    .neon-text-cyan {
      text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
    }
    .neon-text-green {
       text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14;
    }
    .neon-text-red {
       text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000;
    }
    .neon-text-gold {
        text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700;
    }
    .neon-button-glow {
      transition: all 0.2s ease-in-out;
    }
    .neon-button-glow:hover {
      box-shadow: 0 0 5px #00ffff, 0 0 15px #00ffff, 0 0 25px #00ffff;
    }
    .vip-name {
      color: #FFD700;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
      font-weight: bold;
    }
    .vip-msg {
      border-left: 3px solid #FFD700;
      background: rgba(255, 215, 0, 0.05);
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 2px #39FF14, 0 0 4px #39FF14; }
      50% { box-shadow: 0 0 6px #39FF14, 0 0 12px #39FF14; }
    }
     @keyframes pulse-red {
      0%, 100% { text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
      50% { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000; }
    }
    @keyframes pulse-red-dot {
        0%, 100% { box-shadow: 0 0 3px #ff0000, 0 0 5px #ff0000; }
        50% { box-shadow: 0 0 8px #ff0000, 0 0 12px #ff0000; }
    }
    .pulse-dot {
      animation: pulse-green 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
    }
     .recording-active {
        animation: pulse-red 1.5s infinite;
        color: #ff0000;
    }
    .notification-dot {
        animation: pulse-red-dot 1.5s infinite;
    }
    @keyframes pulse-premium {
        0%, 100% { box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7; }
        50% { box-shadow: 0 0 15px #a855f7, 0 0 25px #a855f7; }
    }
     @keyframes pulse-cyan-button {
      0%, 100% { box-shadow: 0 0 4px #00ffff, 0 0 8px #00ffff; transform: scale(1); }
      50% { box-shadow: 0 0 12px #00ffff, 0 0 24px #00ffff; transform: scale(1.02); }
    }
    .neon-pulse-cyan {
        animation: pulse-cyan-button 2.5s infinite;
    }
    .neon-premium-glow {
        animation: pulse-premium 2.5s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    .animated-stars {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: 
        radial-gradient(1px 1px at 20% 30%, #fff, transparent), radial-gradient(1px 1px at 80% 10%, #fff, transparent),
        radial-gradient(1px 1px at 50% 70%, #fff, transparent), radial-gradient(2px 2px at 90% 80%, #fff, transparent),
        radial-gradient(2px 2px at 10% 90%, #fff, transparent);
      background-repeat: repeat; background-size: 300px 300px; animation: zoom 15s infinite alternate; opacity: 0.5;
    }
    @keyframes zoom {
      from { transform: scale(1); }
      to { transform: scale(1.2); }
    }
    /* Hide scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* VIP Modal Styles */
    @keyframes premium-border-glow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .animated-premium-border {
        position: relative;
        padding: 3px;
        background-color: #000;
        z-index: 1;
    }
    .animated-premium-border::before {
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
        z-index: -1;
        margin: -3px; /* equal to padding */
        border-radius: inherit; /* inherit container's border-radius */
        background: linear-gradient(90deg, #a855f7, #ffd700, #a855f7);
        background-size: 200% 200%;
        animation: premium-border-glow 4s linear infinite;
    }
  </style>
</head>

<body class="bg-black text-white w-screen h-screen overflow-hidden">
  <div class="animated-stars"></div>

  <!-- Loading Overlay (Global) -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex-col items-center justify-center z-50">
    <div class="w-16 h-16 border-4 border-dashed border-cyan-500 rounded-full animate-spin"></div>
    <p id="loading-msg" class="text-xl text-cyan-400 tracking-wider mt-4">Verificando login...</p>
  </div>

  <!-- Landing Screen -->
  <div id="landing-screen" class="hidden w-full h-full flex-col items-center justify-center p-4 relative z-10">
      <div class="text-center space-y-8">
          <h1 class="text-7xl md:text-9xl font-black text-white neon-text-green tracking-widest">VOID CHAT</h1>
          <button id="enter-void-btn" class="text-2xl font-bold py-4 px-10 rounded-md text-black bg-cyan-400 border-2 border-cyan-200 neon-pulse-cyan transition-all uppercase">
              [ Entrar no Vazio ]
          </button>
      </div>
  </div>


  <!-- Login Screen -->
  <div id="login-screen" class="hidden w-full h-full flex items-center justify-center p-4 relative z-10">
    <div class="w-full max-w-md bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-8 neon-border-cyan space-y-6">
      <div class="text-center">
        <h1 class="text-4xl font-black text-white neon-text-green">VOID CHAT</h1>
        <p class="text-cyan-400 neon-text-cyan text-sm">Acesse o Vazio.</p>
      </div>
      <form id="login-form" class="space-y-4">
        <div>
          <label for="email" class="block text-cyan-400 text-sm mb-1">Email</label>
          <input type="email" id="email" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
        </div>
        <div>
          <label for="password" class="block text-cyan-400 text-sm mb-1">Senha</label>
          <input type="password" id="password" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
        </div>
        <p id="auth-error" class="text-red-500 text-xs text-center h-4"></p>
        <div class="space-y-2">
            <button type="submit" id="login-btn" class="w-full font-bold py-2 px-4 rounded-md text-white bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 transition-all">Entrar</button>
            <button type="button" id="signup-btn" class="w-full font-bold py-2 px-4 rounded-md text-cyan-400 border-2 border-cyan-400 hover:bg-cyan-400 hover:text-black transition-all">Criar Conta</button>
        </div>
      </form>
      <div class="flex items-center text-gray-500">
        <hr class="flex-grow border-gray-700" />
        <span class="px-2 text-xs">OU</span>
        <hr class="flex-grow border-gray-700" />
      </div>
       <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 font-sans font-medium py-2 px-4 rounded-md text-black bg-white hover:bg-gray-200 transition-all">
          <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
          Entrar com Google
      </button>
    </div>
  </div>

  <!-- Profile Creation Modal -->
  <div id="profile-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
      <div class="w-full max-w-lg bg-black/50 border border-cyan-500 rounded-lg p-8 neon-border-cyan space-y-6">
          <div class="text-center">
              <h1 class="text-3xl font-bold text-white neon-text-green">COMPLETE SEU PERFIL</h1>
              <p class="text-cyan-400 neon-text-cyan text-sm">Sua identidade para mergulhar no Vazio.</p>
          </div>
          <form id="profile-form" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label for="username-input" class="block text-cyan-400 text-sm mb-1">Username</label>
                      <input type="text" id="username-input" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                  </div>
                  <div>
                      <label for="gender-select" class="block text-cyan-400 text-sm mb-1">Sexo</label>
                      <select id="gender-select" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                          <option value="">Selecione...</option>
                          <option value="Masculino">Masculino</option>
                          <option value="Feminino">Feminino</option>
                          <option value="Outro">Outro</option>
                      </select>
                  </div>
                  <div>
                      <label for="region-select" class="block text-cyan-400 text-sm mb-1">Região (Estado)</label>
                      <select id="region-select" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                        <!-- Options will be populated by JS -->
                      </select>
                  </div>
                   <div>
                      <label for="interests-input" class="block text-cyan-400 text-sm mb-1">Interesses</label>
                      <input type="text" id="interests-input" placeholder="Games, Música, etc" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                  </div>
              </div>
               <div>
                  <label for="avatar-input" class="block text-cyan-400 text-sm mb-1">URL da Foto de Perfil / Avatar</label>
                  <input type="url" id="avatar-input" placeholder="https://exemplo.com/imagem.png" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
              </div>

              <p id="full-profile-error" class="text-red-500 text-xs text-center h-4"></p>
              <button type="submit" id="save-full-profile-btn" class="w-full font-bold py-3 px-4 rounded-md text-black bg-cyan-400 neon-button-glow transition-all text-lg">SALVAR NO VAZIO</button>
          </form>
      </div>
  </div>

  <!-- Home Screen -->
    <div id="home-screen" class="hidden w-full h-full flex flex-col justify-center items-center p-4 relative z-10">
        <div class="text-center mb-12">
            <h1 class="text-6xl md:text-8xl font-black text-white neon-text-green tracking-widest">VOID CHAT</h1>
            <p class="text-cyan-400 mt-4 neon-text-cyan">ESCOLHA SEU CAMINHO NO VAZIO.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-4xl">
            <!-- Card 1: Global Chat -->
            <div id="global-chat-card" class="bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-900/50 transition-all cursor-pointer">
                <i class="fas fa-globe text-4xl text-cyan-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">CHAT GLOBAL</h2>
                <p class="text-gray-400 text-sm mt-2">Converse com todos os usuários online em uma única sala.</p>
            </div>

            <!-- Card 2: Random Void (Matchmaking) -->
            <div id="match-btn" class="bg-white/5 backdrop-blur-md border-2 border-cyan-400 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-800/60 transition-all cursor-pointer transform hover:scale-105">
                <i class="fas fa-random text-4xl text-cyan-300 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">RANDOM VOID</h2>
                <p class="text-gray-300 text-sm mt-2">Mergulhe no desconhecido e encontre uma conexão anônima aleatória.</p>
            </div>

            <!-- Card 3: Private Chat -->
            <div id="private-chat-card" class="relative bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-900/50 transition-all cursor-pointer">
                <div id="private-chat-notification" class="hidden absolute top-3 right-3 w-4 h-4 bg-red-600 rounded-full border-2 border-black notification-dot"></div>
                <i class="fas fa-user-secret text-4xl text-cyan-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">CHAT PRIVADO</h2>
                <p class="text-gray-400 text-sm mt-2">Inicie conversas diretas com seus contatos.</p>
            </div>
        </div>

        <footer class="absolute bottom-0 left-0 right-0 p-4 bg-black/50 border-t border-cyan-500/20 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div id="user-profile-footer" class="flex items-center gap-3 cursor-pointer group">
                    <img id="user-avatar-home" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-cyan-400 group-hover:border-white transition-all">
                    <div>
                        <p id="user-name-home" class="font-bold text-white group-hover:text-cyan-300 transition-all">Carregando...</p>
                        <p id="user-region-home" class="text-xs text-gray-400">...</p>
                    </div>
                </div>
                <div class="relative">
                    <button id="notifications-btn" class="text-2xl text-cyan-400 hover:text-white transition-colors">
                        <i class="fas fa-bell"></i>
                    </button>
                    <span id="friend-request-notification" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-600 rounded-full border-2 border-black notification-dot"></span>
                </div>
                 <button id="admin-btn" class="hidden ml-4 font-bold py-1 px-3 rounded-md text-black bg-green-500 border border-green-300 neon-border-green">
                    <i class="fas fa-shield-halved mr-1"></i>ADMIN
                </button>
            </div>
            <button id="premium-btn" class="font-bold py-2 px-5 rounded-md text-white bg-purple-600 border border-purple-400 neon-premium-glow">
                <i class="fas fa-star mr-2"></i>ATIVAR PREMIUM
            </button>
        </footer>
    </div>


  <!-- Scanning Screen (Simplified) -->
  <div id="entry-screen" class="hidden w-full h-full flex-col items-center justify-center p-4 text-center relative z-10">
    <div id="scanning-content" class="flex-col items-center justify-center space-y-4">
      <div class="w-16 h-16 border-4 border-dashed border-cyan-500 rounded-full animate-spin"></div>
      <p class="text-xl text-cyan-400 tracking-wider">BUSCANDO CONEXÃO REAL...</p>
    </div>
  </div>

  <!-- Chat Screen (1-on-1 Random) -->
  <main id="chat-screen" class="hidden w-full h-screen p-4 flex gap-4 font-orbitron bg-black relative overflow-hidden z-10">
    <!-- Left Sidebar -->
    <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
      <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center border-b border-cyan-500/30 pb-2">STATUS</h2>
      <div class="flex-grow flex flex-col justify-center items-center text-center">
        <div class="relative flex items-center justify-center w-24 h-24 mb-4">
          <div class="absolute inset-0 bg-green-500/50 rounded-full animate-ping"></div>
          <img id="my-avatar-chat" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" class="w-20 h-20 rounded-full border-2 border-cyan-300 z-10">
        </div>
        <p class="text-2xl font-bold text-green-400 neon-text-green">ONLINE</p>
        <p class="text-sm text-gray-400">Você está conectado ao Vazio.</p>
      </div>
       <div class="text-center border-t border-cyan-500/30 pt-4 space-y-3">
          <div>
            <p id="online-users" class="text-lg text-white">1</p>
            <p class="text-sm text-cyan-400 neon-text-cyan flex items-center justify-center gap-2">
              <span class="w-3 h-3 bg-green-400 rounded-full pulse-dot"></span>
              HUMANOS CONECTADOS
            </p>
          </div>
          <button id="random-chat-exit-btn" class="w-full p-2 bg-red-800/50 hover:bg-red-700/50 border border-red-500/50 rounded-md transition-colors text-sm">
            <i class="fas fa-sign-out-alt mr-2"></i>SAIR DA SALA
          </button>
      </div>
    </aside>

    <!-- Center Chat -->
    <section class="w-1/2 h-full flex flex-col bg-black/50 border border-gray-700/50 rounded-lg overflow-hidden z-10">
        <header class="p-3 border-b border-gray-700/50 text-center flex items-center gap-4 justify-center">
          <img id="partner-avatar-chat" src="https://i.pravatar.cc/150?u=a042581f4e29026704e" class="w-10 h-10 rounded-full border-2 border-gray-500">
          <div>
            <h3 id="partner-name" class="font-bold text-lg text-white">CONEXÃO ESTABELECIDA</h3>
            <p id="partner-info" class="text-xs text-gray-400">Você está conversando com um estranho.</p>
          </div>
        </header>
        <div id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
          <!-- Messages will be injected here -->
        </div>
        <footer class="p-3 border-t border-gray-700/50 bg-black/50">
          <form id="message-form" class="flex items-center gap-3">
            <input type="text" id="message-input" placeholder="Digite no Vazio..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
            <button type="submit" id="send-btn" class="bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-700 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-md transition-colors">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </footer>
    </section>

    <!-- Right Sidebar -->
    <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
      <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center border-b border-cyan-500/30 pb-2">ÁREA VIP</h2>
      <div class="flex-grow flex flex-col justify-center gap-4">
          <button class="w-full text-center p-4 border-2 border-cyan-400 rounded-md neon-button-glow hover:bg-cyan-400 hover:text-black transition-all">
            <p class="font-bold text-lg">ATIVAR FILTRO DE GÊNERO</p>
            <p class="text-xs font-sans">REQUER ASSINATURA VIP</p>
          </button>
          <button class="w-full text-center p-4 border-2 border-purple-500 text-purple-400 rounded-md neon-button-glow hover:bg-purple-500 hover:text-black transition-all">
            <p class="font-bold text-lg">TURBO MATCH</p>
            <p class="text-xs font-sans">CONEXÃO IMEDIATA</p>
          </button>
      </div>
      <button id="next-btn" class="w-full p-3 bg-gray-700 hover:bg-gray-600 border border-gray-500 rounded-md transition-colors">
        PRÓXIMO
      </button>
    </aside>
  </main>

    <!-- Global Chat Screen -->
    <main id="global-chat-screen" class="hidden w-full h-screen p-4 flex gap-4 font-orbitron bg-black relative overflow-hidden z-10">
        <!-- Left Sidebar - Online Users -->
        <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-2">
                 <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center">ONLINE</h2>
                 <button id="global-chat-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </button>
            </div>
            <div id="global-online-users-list" class="flex-grow overflow-y-auto space-y-1 no-scrollbar pr-2">
                <!-- User list will be populated here -->
            </div>
        </aside>

        <!-- Center Chat -->
        <section class="w-3/4 h-full flex flex-col bg-black/50 border border-gray-700/50 rounded-lg overflow-hidden z-10">
            <header class="p-3 border-b border-gray-700/50 text-center">
                <h3 class="font-bold text-lg text-white neon-text-cyan">CHAT GLOBAL</h3>
                <p class="text-xs text-gray-400">Todos os humanos conectados no Vazio.</p>
            </header>
            <div id="global-chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
                <!-- Global messages will be injected here -->
            </div>
            <footer class="p-3 border-t border-gray-700/50 bg-black/50">
                <form id="global-message-form" class="flex items-center gap-3">
                    <input type="text" id="global-message-input" placeholder="Converse com o mundo..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
                    <button type="button" id="record-audio-btn" class="text-cyan-400 hover:text-white text-xl px-3 transition-colors">
                      <i class="fas fa-microphone"></i>
                    </button>
                    <button type="submit" id="global-send-btn" class="bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-700 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </footer>
        </section>
    </main>
    
    <!-- Contacts Screen -->
    <div id="contacts-screen" class="hidden w-full h-full flex flex-col justify-center items-center p-4 relative z-10">
        <div class="w-full max-w-2xl h-4/5 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 neon-border-cyan flex flex-col">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-3 mb-4">
                <h2 class="text-3xl font-bold text-cyan-400 neon-text-cyan">CONTATOS</h2>
                <button id="contacts-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                   <i class="fas fa-times fa-lg"></i>
               </button>
           </div>
           <div id="contacts-list" class="flex-grow overflow-y-auto space-y-2 no-scrollbar pr-2">
               <!-- Contacts list will be populated here -->
           </div>
        </div>
    </div>

    <!-- Private Chat Screen -->
    <main id="private-chat-screen" class="hidden w-full h-screen p-4 flex justify-center items-center font-orbitron bg-black relative overflow-hidden z-10">
        <section class="w-full max-w-3xl h-5/6 flex flex-col bg-black/50 border border-cyan-500/50 neon-border-cyan rounded-lg overflow-hidden z-10">
            <header class="p-3 border-b border-cyan-500/50 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img id="private-chat-partner-avatar" src="https://i.pravatar.cc/150?u=a042581f4e29026704e" class="w-10 h-10 rounded-full border-2 border-gray-500">
                    <div>
                      <h3 id="private-chat-partner-name" class="font-bold text-lg text-white">Carregando...</h3>
                      <p id="private-chat-partner-status" class="text-xs text-red-500 neon-text-red">Offline</p>
                    </div>
                </div>
                <button id="private-chat-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </button>
            </header>
            <div id="private-chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
                <!-- Private messages will be injected here -->
            </div>
            <footer class="p-3 border-t border-cyan-500/50 bg-black/50">
                <form id="private-message-form" class="flex items-center gap-3">
                    <input type="text" id="private-message-input" placeholder="Envie uma mensagem privada..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
                    <button type="submit" id="private-send-btn" class="bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </footer>
        </section>
    </main>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
        <div class="w-full max-w-md h-auto max-h-[80vh] bg-black/50 border border-cyan-500 rounded-lg p-6 neon-border-cyan flex flex-col">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-3 mb-4">
                <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan">NOTIFICAÇÕES</h2>
                <button id="notifications-close-btn" class="text-cyan-400 hover:text-white transition-colors">
                   <i class="fas fa-times fa-lg"></i>
               </button>
           </div>
           <div id="notifications-list" class="flex-grow overflow-y-auto space-y-3 no-scrollbar pr-2">
               <!-- Friend requests will be populated here -->
           </div>
        </div>
    </div>

    <!-- VOID VIP Upgrade Modal -->
    <div id="vip-modal" class="hidden absolute inset-0 bg-black/80 backdrop-blur-xl items-center justify-center p-4 z-50">
      <div class="w-full max-w-lg rounded-lg animated-premium-border">
          <div class="relative bg-black/90 p-8 rounded-lg">
              <button id="vip-modal-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-20">
                  <i class="fas fa-times fa-2x"></i>
              </button>
              <div class="text-center mb-6">
                  <h2 class="text-3xl font-black text-white" style="text-shadow: 0 0 8px #a855f7;">UPGRADE DE SISTEMA</h2>
                  <p class="text-4xl font-black text-purple-400" style="text-shadow: 0 0 5px #a855f7, 0 0 10px #ffd700;">VOID VIP</p>
              </div>
              <ul class="space-y-4 text-lg mb-8">
                  <li class="flex items-center gap-4"><i class="fas fa-gem w-6 text-center text-yellow-400 neon-text-gold"></i><span><span class="font-bold">Nome Dourado + Selo VIP:</span> Destaque-se em todos os chats.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-infinity w-6 text-center text-yellow-400 neon-text-gold"></i><span><span class="font-bold">Matching Sem Limites:</span> Encontre novas conexões sem restrições.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-users w-6 text-center text-yellow-400 neon-text-gold"></i><span><span class="font-bold">Amigos Ilimitados:</span> Adicione quantos amigos quiser.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-microphone-alt w-6 text-center text-purple-400" style="text-shadow: 0 0 6px #a855f7;"></i><span><span class="font-bold">Áudios Ilimitados:</span> Envie quantos áudios quiser.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-shield-alt w-6 text-center text-purple-400" style="text-shadow: 0 0 6px #a855f7;"></i><span><span class="font-bold">Sem Anúncios:</span> Experiência limpa no Vazio.</span></li>
              </ul>
              <button id="vip-modal-action-btn" class="w-full font-bold py-4 px-4 rounded-md text-black bg-purple-500 border-2 border-purple-300 transition-all text-xl uppercase tracking-widest neon-premium-glow hover:bg-purple-400">
                  Adquirir Acesso Agora
              </button>
          </div>
      </div>
    </div>
    
    <!-- Support FAB -->
    <button id="support-fab" class="fixed bottom-5 right-5 w-14 h-14 bg-cyan-500 text-black rounded-full flex items-center justify-center shadow-lg neon-button-glow z-30">
        <i class="fas fa-question text-2xl"></i>
    </button>

    <!-- Support Modal -->
    <div id="support-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
        <div class="w-full max-w-lg bg-black/50 border border-cyan-500 rounded-lg p-8 neon-border-cyan space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-white neon-text-cyan">SUPORTE</h1>
                <button id="support-modal-close-btn" class="text-cyan-400 hover:text-white transition-colors">
                   <i class="fas fa-times fa-lg"></i>
               </button>
            </div>
            <form id="support-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="support-name" class="block text-cyan-400 text-sm mb-1">Nome</label>
                        <input type="text" id="support-name" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                    </div>
                    <div>
                        <label for="support-email" class="block text-cyan-400 text-sm mb-1">E-mail</label>
                        <input type="email" id="support-email" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                    </div>
                </div>
                <div>
                    <label for="support-subject" class="block text-cyan-400 text-sm mb-1">Tipo de Problema</label>
                    <select id="support-subject" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                        <option value="Bug">Bug</option>
                        <option value="Sugestão">Sugestão</option>
                        <option value="Esqueci Senha">Esqueci Senha</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="support-description" class="block text-cyan-400 text-sm mb-1">Descrição</label>
                    <textarea id="support-description" rows="4" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all"></textarea>
                </div>
                <button type="submit" id="support-submit-btn" class="w-full font-bold py-3 px-4 rounded-md text-black bg-cyan-400 neon-button-glow transition-all text-lg">ENVIAR CHAMADO</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden w-full h-full flex flex-col p-4 relative z-20">
        <div class="flex items-center justify-between border-b border-green-500/30 pb-3 mb-4">
            <h2 class="text-3xl font-bold text-green-400 neon-text-green">PAINEL ADMIN - TICKETS</h2>
            <button id="admin-panel-back-btn" class="text-green-400 hover:text-white transition-colors">
               <i class="fas fa-arrow-left fa-lg mr-2"></i> VOLTAR
           </button>
       </div>
       <div id="admin-tickets-list" class="flex-grow overflow-y-auto space-y-4 no-scrollbar pr-2">
           <!-- Tickets will be populated here -->
       </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

  // ---=== ADMIN CONFIG ===---
  const ADMIN_UID = 'lxWxEwMGCee1Hcu01qIdHydafQf2'; // Substitua pelo seu UID do Firebase Auth

  // Iframe check to prevent disallowed_useragent error with Google Auth
  try {
    if (window.self !== window.top) {
        document.body.innerHTML = `<div class="bg-black text-red-500 w-screen h-screen flex items-center justify-center p-4 text-center"><h1 class="text-2xl font-bold">ERRO: Este aplicativo não pode ser executado em um iframe.</h1></div>`;
        return;
    }
  } catch (e) {
    console.warn("Iframe check failed, might be due to cross-origin policies. Proceeding with caution.");
  }


  // ---=== FIREBASE CONFIGURATION ===---
  const firebaseConfig = {
    apiKey: "AIzaSyCJY8KnCAmegTJKgxk8Vb0fdDU64JV-zbU",
    authDomain: "meuchatreal.firebaseapp.com",
    databaseURL: "https://meuchatreal-default-rtdb.firebaseio.com",
    projectId: "meuchatreal",
    storageBucket: "meuchatreal.appspot.com",
    messagingSenderId: "271430524108",
    appId: "1:271430524108:web:e23b8c36a188f150467669"
  };

  // ---=== INITIALIZATION ===---
  let db, auth, storage;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    auth = firebase.auth();
    storage = firebase.storage();
  } catch (e) {
    console.error("Firebase initialization failed.", e);
    document.body.innerHTML = `<div class="bg-black text-red-500 w-screen h-screen flex items-center justify-center p-4 text-center"><h1 class="text-2xl font-bold">ERRO CRÍTICO: Falha na inicialização do Firebase. Verifique a configuração.</h1></div>`;
    return;
  }

  // ---=== DOM ELEMENTS ===---
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingMsg = document.getElementById('loading-msg');
  const landingScreen = document.getElementById('landing-screen');
  const loginScreen = document.getElementById('login-screen');
  const profileModal = document.getElementById('profile-modal');
  const homeScreen = document.getElementById('home-screen');
  const entryScreen = document.getElementById('entry-screen');
  const chatScreen = document.getElementById('chat-screen');
  const globalChatScreen = document.getElementById('global-chat-screen');
  const contactsScreen = document.getElementById('contacts-screen');
  const privateChatScreen = document.getElementById('private-chat-screen');
  const notificationsModal = document.getElementById('notifications-modal');
  const vipModal = document.getElementById('vip-modal');
  const supportModal = document.getElementById('support-modal');
  const adminPanel = document.getElementById('admin-panel');

  const enterVoidBtn = document.getElementById('enter-void-btn');
  const adminBtn = document.getElementById('admin-btn');
  const adminPanelBackBtn = document.getElementById('admin-panel-back-btn');
  const adminTicketsList = document.getElementById('admin-tickets-list');
  
  const loginForm = document.getElementById('login-form');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const signupBtn = document.getElementById('signup-btn');
  const googleSigninBtn = document.getElementById('google-signin-btn');
  const authErrorEl = document.getElementById('auth-error');
  const randomChatExitBtn = document.getElementById('random-chat-exit-btn');

  const profileForm = document.getElementById('profile-form');
  const usernameInput = document.getElementById('username-input');
  const genderSelect = document.getElementById('gender-select');
  const regionSelect = document.getElementById('region-select');
  const interestsInput = document.getElementById('interests-input');
  const avatarInput = document.getElementById('avatar-input');
  const saveFullProfileBtn = document.getElementById('save-full-profile-btn');
  const fullProfileErrorEl = document.getElementById('full-profile-error');

  const userProfileFooter = document.getElementById('user-profile-footer');
  const userAvatarHome = document.getElementById('user-avatar-home');
  const userNameHome = document.getElementById('user-name-home');
  const userRegionHome = document.getElementById('user-region-home');

  const matchBtn = document.getElementById('match-btn');
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');
  const chatContainer = document.getElementById('chat-container');
  const partnerNameEl = document.getElementById('partner-name');
  const partnerInfoEl = document.getElementById('partner-info');
  const myAvatarChatEl = document.getElementById('my-avatar-chat');
  const partnerAvatarChatEl = document.getElementById('partner-avatar-chat');
  const nextBtn = document.getElementById('next-btn');
  const onlineUsersEl = document.getElementById('online-users');

  // Global Chat Elements
  const globalChatCard = document.getElementById('global-chat-card');
  const globalChatBackBtn = document.getElementById('global-chat-back-btn');
  const globalOnlineUsersList = document.getElementById('global-online-users-list');
  const globalChatContainer = document.getElementById('global-chat-container');
  const globalMessageForm = document.getElementById('global-message-form');
  const globalMessageInput = document.getElementById('global-message-input');
  const recordAudioBtn = document.getElementById('record-audio-btn');
  
  // Private Chat, Contacts & Notifications Elements
  const privateChatCard = document.getElementById('private-chat-card');
  const privateChatNotification = document.getElementById('private-chat-notification');
  const contactsBackBtn = document.getElementById('contacts-back-btn');
  const contactsList = document.getElementById('contacts-list');
  const privateChatBackBtn = document.getElementById('private-chat-back-btn');
  const privateChatPartnerAvatar = document.getElementById('private-chat-partner-avatar');
  const privateChatPartnerName = document.getElementById('private-chat-partner-name');
  const privateChatPartnerStatus = document.getElementById('private-chat-partner-status');
  const privateChatContainer = document.getElementById('private-chat-container');
  const privateMessageForm = document.getElementById('private-message-form');
  const privateMessageInput = document.getElementById('private-message-input');
  const notificationsBtn = document.getElementById('notifications-btn');
  const friendRequestNotification = document.getElementById('friend-request-notification');
  const notificationsCloseBtn = document.getElementById('notifications-close-btn');
  const notificationsList = document.getElementById('notifications-list');

  // VIP Modal Elements
  const premiumBtn = document.getElementById('premium-btn');
  const vipModalCloseBtn = document.getElementById('vip-modal-close-btn');
  const vipModalActionBtn = document.getElementById('vip-modal-action-btn');

  // Support Elements
  const supportFab = document.getElementById('support-fab');
  const supportModalCloseBtn = document.getElementById('support-modal-close-btn');
  const supportForm = document.getElementById('support-form');
  const supportName = document.getElementById('support-name');
  const supportEmail = document.getElementById('support-email');


  // ---=== STATE VARIABLES ===---
  let currentUser = null;
  let currentUserProfile = null;
  let adminTicketsListener = null;
  // Matchmaking State
  let sessionId = null;
  let chatRoomId = null;
  let partnerId = null;
  let roomRef = null;
  let messagesListener = null;
  let roomValueListener = null;
  let chatParticipantData = {};
  // Global Chat State
  let globalMessagesListener = null;
  let globalOnlineListener = null;
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  // Private Chat State & Friends
  let currentPrivateChatFriend = null;
  let privateChatRoomId = null;
  let privateMessagesListener = null;
  let contactsListener = null;
  let presenceListener = null;
  let notificationListener = null;
  let friendRequestListener = null;
  let sentRequestListener = null;
  let receivedFriendRequests = {};
  let sentFriendRequests = {};

  // ---=== UI HELPER FUNCTIONS ===---
  const setLoadingState = (isLoading, message = '') => {
      if (isLoading) {
          loadingMsg.textContent = message;
          loadingOverlay.classList.remove('hidden');
          loadingOverlay.classList.add('flex');
      } else {
          loadingOverlay.classList.add('hidden');
          loadingOverlay.classList.remove('flex');
      }
  };

  const showView = (view) => {
    ['landing-screen', 'login-screen', 'home-screen', 'entry-screen', 'chat-screen', 'global-chat-screen', 
     'contacts-screen', 'private-chat-screen', 'admin-panel'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });
    
    const viewMap = {
      landing: landingScreen, login: loginScreen, home: homeScreen, scanning: entryScreen,
      chat: chatScreen, 'global-chat': globalChatScreen,
      'contacts': contactsScreen, 'private-chat': privateChatScreen, admin: adminPanel
    };
    if(viewMap[view]) {
      viewMap[view].classList.remove('hidden');
      // Use flex for all main screens for consistency
      viewMap[view].classList.add('flex');
    }
  };
  
  const showProfileModal = (show) => {
    if (show) {
        profileModal.classList.remove('hidden');
        profileModal.classList.add('flex');
    } else {
        profileModal.classList.add('hidden');
        profileModal.classList.remove('flex');
    }
  };

  const showSupportModal = (show) => {
    if (show) {
        if(currentUserProfile) {
            supportName.value = currentUserProfile.username;
            supportEmail.value = currentUser.email;
        }
        supportModal.classList.remove('hidden');
        supportModal.classList.add('flex');
    } else {
        supportModal.classList.add('hidden');
        supportModal.classList.remove('flex');
    }
  };

  const showVipModal = (show) => {
    if (show) {
        vipModal.classList.remove('hidden');
        vipModal.classList.add('flex');
    } else {
        vipModal.classList.add('hidden');
        vipModal.classList.remove('flex');
    }
  };
  
  const showNotificationsModal = (show) => {
    if (show) {
        notificationsModal.classList.remove('hidden');
        notificationsModal.classList.add('flex');
    } else {
        notificationsModal.classList.add('hidden');
        notificationsModal.classList.remove('flex');
    }
  };
  
  const populateRegions = () => {
    const states = ["Acre", "Alagoas", "Amapá", "Amazonas", "Bahia", "Ceará", "Distrito Federal", "Espírito Santo", "Goiás", "Maranhão", "Mato Grosso", "Mato Grosso do Sul", "Minas Gerais", "Pará", "Paraíba", "Paraná", "Pernambuco", "Piauí", "Rio de Janeiro", "Rio Grande do Norte", "Rio Grande do Sul", "Rondônia", "Roraima", "Santa Catarina", "São Paulo", "Sergipe", "Tocantins"];
    regionSelect.innerHTML = '<option value="">Selecione seu estado...</option>';
    states.forEach(state => regionSelect.appendChild(new Option(state, state)));
  };
  populateRegions();
  
  const updateUI = (profile) => {
      if (!profile) return;
      userAvatarHome.src = profile.avatar || 'https://i.pravatar.cc/150?u=a042581f4e29026704d';
      userNameHome.textContent = profile.username;
      userRegionHome.textContent = profile.region;
  };
  
  const populateProfileModal = (profile) => {
      if (!profile) return;
      usernameInput.value = profile.username || '';
      genderSelect.value = profile.gender || '';
      regionSelect.value = profile.region || '';
      interestsInput.value = profile.interests || '';
      avatarInput.value = profile.avatar || '';
  };
  
  
  // ---=== AUTHENTICATION & PROFILE LOGIC ===---
  const handleAuthError = (error) => {
    setLoadingState(false);
    let message = 'Ocorreu um erro. Tente novamente.';
    if(error.code) {
        switch (error.code) {
            case 'auth/user-not-found': case 'auth/wrong-password': message = 'Email ou senha inválidos.'; break;
            case 'auth/email-already-in-use': message = 'Este email já está em uso.'; break;
            case 'auth/weak-password': message = 'A senha deve ter pelo menos 6 caracteres.'; break;
            case 'auth/account-exists-with-different-credential': message = 'Uma conta já existe com este email.'; break;
        }
    }
    authErrorEl.textContent = message;
    console.error("Auth Error:", error);
  };
  
  const managePresence = (user) => {
    const userStatusRef = db.ref(`/presence/${user.uid}`);
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => {
      if (snap.val() === true) {
        userStatusRef.set(true);
        userStatusRef.onDisconnect().remove();
      }
    });
  };

  const listenForNotifications = (user) => {
      const notificationsRef = db.ref(`notifications/${user.uid}`);
      if (notificationListener) notificationsRef.off('value', notificationListener);
      notificationListener = notificationsRef.on('value', snapshot => {
          privateChatNotification.classList.toggle('hidden', !snapshot.exists());
      });
  };
  
  const startApp = () => {
    setLoadingState(true, 'Inicializando Vazio...');
    auth.getRedirectResult().catch(handleAuthError);

    auth.onAuthStateChanged((user) => {
      adminBtn.classList.add('hidden'); // Hide admin button on auth change
      if (currentUser) db.ref().off(); // Detach old listeners
      
      if (user) {
        currentUser = user;
        if (currentUser.uid === ADMIN_UID) {
            adminBtn.classList.remove('hidden');
        }

        const userRef = db.ref(`users/${user.uid}`);
        
        userRef.once('value').then(async (snapshot) => {
          const profile = snapshot.val();
          const isProfileComplete = profile && profile.username && profile.gender && profile.region && profile.interests && profile.avatar;

          if (isProfileComplete) {
            const contactsSnapshot = await db.ref(`users/${user.uid}/contacts`).once('value');
            profile.contacts = contactsSnapshot.val() || {};
            currentUserProfile = profile;
            
            updateUI(currentUserProfile);
            populateProfileModal(currentUserProfile);
            
            showView('home');

            managePresence(user);
            listenForNotifications(user);
            listenForFriendRequests(user);
          } else {
            // Logged in, but profile is incomplete
            currentUserProfile = null;
            showProfileModal(true);
          }
          setLoadingState(false);
        }).catch((error) => {
          console.error("Error fetching user profile:", error);
          setLoadingState(false);
          showView('login'); // Fallback to login on profile fetch error
        });
      } else {
        // No user is logged in
        currentUser = null;
        currentUserProfile = null;
        showView('landing'); // Show the new landing screen
        setLoadingState(false);
      }
    });
  };

  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => startApp())
    .catch((error) => {
        console.error("Error setting persistence:", error);
        startApp();
    });

  // ---=== RANDOM CHAT (MATCHMAKING) LOGIC ===---
  const findPartner = async () => {
    if (!currentUser) return;
    resetRandomChatState();
    showView('scanning');
    
    const queueRef = db.ref('queue');
    const myQueueEntryRef = queueRef.push();
    sessionId = myQueueEntryRef.key;

    myQueueEntryRef.onDisconnect().remove();
    await myQueueEntryRef.set({ userId: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP });

    const onPartnerFound = (partnerSessionId, partnerUserId) => {
        const sortedIds = [currentUser.uid, partnerUserId].sort();
        chatRoomId = `room_${sortedIds[0]}_${sortedIds[1]}`;
        
        const roomMembers = { [currentUser.uid]: true, [partnerUserId]: true };
        roomRef = db.ref(`rooms/${chatRoomId}`);
        roomRef.set({ members: roomMembers, createdAt: firebase.database.ServerValue.TIMESTAMP }).then(() => {
          db.ref(`queue/${partnerSessionId}`).remove();
          myQueueEntryRef.onDisconnect().cancel();
          myQueueEntryRef.remove();
          sessionId = null;
          startChat(partnerUserId);
        }).catch(err => { resetRandomChatState(); showView('home'); });
    };

    const queueListener = queueRef.on('value', snapshot => {
        const otherUsers = Object.entries(snapshot.val() || {}).filter(([key, val]) => val.userId !== currentUser.uid);
        if (otherUsers.length > 0) {
            queueRef.off('value', queueListener);
            const [partnerSessionId, partnerData] = otherUsers[0];
            onPartnerFound(partnerSessionId, partnerData.userId);
        }
    });
  };

  const startChat = async (pId) => {
    if (!currentUser || !chatRoomId) return;
    partnerId = pId;
    
    const partnerProfileSnapshot = await db.ref(`users/${partnerId}`).once('value');
    chatParticipantData = {}; // Reset before filling
    chatParticipantData[currentUser.uid] = currentUserProfile;
    chatParticipantData[partnerId] = partnerProfileSnapshot.val() || { username: 'Estranho', isPremium: false };
    
    myAvatarChatEl.src = currentUserProfile.avatar;
    partnerAvatarChatEl.src = chatParticipantData[partnerId].avatar;
    partnerNameEl.textContent = chatParticipantData[partnerId].username;
    partnerInfoEl.textContent = `Conectado de ${chatParticipantData[partnerId].region || 'Vazio'}`;

    roomRef = db.ref(`rooms/${chatRoomId}`);
    roomRef.onDisconnect().remove();
    showView('chat');
    
    messagesListener = roomRef.child('messages').on('child_added', (snapshot) => addMessageToUI(snapshot.val(), chatContainer, chatParticipantData));
    
    roomValueListener = roomRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!chatRoomId || !data || !data.members || !data.members[partnerId]) {
        if(roomRef) roomRef.off('value', roomValueListener);
        setLoadingState(true, 'O estranho saiu do Vazio...');
        setTimeout(() => { setLoadingState(false); resetRandomChatState(); showView('home'); }, 2000);
      } else {
         onlineUsersEl.textContent = Object.keys(data.members).length;
      }
    });
  };

  const resetRandomChatState = () => {
    if (roomRef) {
        if (messagesListener) roomRef.child('messages').off('child_added', messagesListener);
        if (roomValueListener) roomRef.off('value', roomValueListener);
        roomRef.remove().catch(e => {});
        roomRef.onDisconnect().cancel();
    }
    if (sessionId) { db.ref(`queue/${sessionId}`).remove().catch(e => {}); sessionId = null; }
    chatRoomId = null; partnerId = null; roomRef = null; messagesListener = null; roomValueListener = null; chatParticipantData = {};
    if(chatContainer) chatContainer.innerHTML = '';
  };

  // ---=== GLOBAL CHAT LOGIC ===---
  const enterGlobalChat = () => {
    if (!currentUser || !currentUserProfile) return;
    const connectedRef = db.ref('.info/connected');
    const userStatusRef = db.ref(`global_online/${currentUser.uid}`);
    
    connectedRef.on('value', (snap) => {
        if(snap.val()) {
            userStatusRef.set({ username: currentUserProfile.username, avatar: currentUserProfile.avatar });
            userStatusRef.onDisconnect().remove();
        }
    });

    globalOnlineListener = db.ref('global_online').on('value', snapshot => updateGlobalOnlineList(snapshot.val() || {}));
    const messagesRef = db.ref('global_messages').limitToLast(50);
    globalMessagesListener = messagesRef.on('child_added', snapshot => addGlobalMessageToUI(snapshot.val()));
    
    showView('global-chat');
  };

  const leaveGlobalChat = () => {
    if (globalMessagesListener) db.ref('global_messages').off('child_added', globalMessagesListener);
    if (globalOnlineListener) db.ref('global_online').off('value', globalOnlineListener);
    db.ref(`global_online/${currentUser.uid}`).remove();
    showView('home');
  };
  
  const updateGlobalOnlineList = (users) => {
      globalOnlineUsersList.innerHTML = '';
      Object.entries(users).forEach(([uid, user]) => {
          const isMe = uid === currentUser.uid;
          const isFriend = currentUserProfile.contacts && currentUserProfile.contacts[uid];
          const isPending = sentFriendRequests[uid];

          const userEl = document.createElement('div');
          userEl.className = 'flex items-center justify-between gap-3 p-2 rounded-md hover:bg-cyan-500/10';
          let buttonHTML = '';
          if (!isMe) {
              if (isFriend) {
                  buttonHTML = `<button disabled class="text-green-500"><i class="fas fa-check"></i></button>`;
              } else if (isPending) {
                  buttonHTML = `<button disabled class="text-yellow-500"><i class="fas fa-clock"></i></button>`;
              } else {
                  buttonHTML = `<button data-friend-id="${uid}" class="add-friend-btn text-cyan-400 hover:text-white"><i class="fas fa-plus"></i></button>`;
              }
          }
          userEl.innerHTML = `<div class="flex items-center gap-3"><img src="${user.avatar}" class="w-8 h-8 rounded-full"><span class="text-sm font-medium text-white">${user.username} ${isMe ? '(Você)' : ''}</span></div> ${buttonHTML}`;
          globalOnlineUsersList.appendChild(userEl);
      });
  };

  // ---=== FRIEND REQUEST LOGIC ---===
  const listenForFriendRequests = (user) => {
      if (friendRequestListener) db.ref(`friend_requests/${user.uid}`).off('value', friendRequestListener);
      friendRequestListener = db.ref(`friend_requests/${user.uid}`).on('value', snapshot => {
          receivedFriendRequests = snapshot.val() || {};
          friendRequestNotification.classList.toggle('hidden', !snapshot.exists());
          updateNotificationsModal();
      });
      if(sentRequestListener) db.ref(`sent_friend_requests/${user.uid}`).off('value', sentRequestListener);
      sentRequestListener = db.ref(`sent_friend_requests/${user.uid}`).on('value', snapshot => {
          sentFriendRequests = snapshot.val() || {};
      });
  };

  const updateNotificationsModal = () => {
      notificationsList.innerHTML = '';
      const requests = Object.entries(receivedFriendRequests);
      if (requests.length === 0) {
          notificationsList.innerHTML = `<p class="text-gray-500 text-center">Nenhuma nova notificação.</p>`;
          return;
      }
      requests.forEach(([requesterId, data]) => {
          const reqEl = document.createElement('div');
          reqEl.className = 'flex items-center justify-between gap-3 p-2 rounded-md bg-gray-800/50';
          reqEl.innerHTML = `
              <div class="flex items-center gap-3">
                  <img src="${data.avatar}" class="w-10 h-10 rounded-full">
                  <p><span class="font-bold">${data.username}</span> quer ser seu amigo.</p>
              </div>
              <div class="flex gap-2">
                  <button data-requester-id="${requesterId}" class="accept-request-btn p-2 bg-green-600 hover:bg-green-500 rounded-md"><i class="fas fa-check"></i></button>
                  <button data-requester-id="${requesterId}" class="decline-request-btn p-2 bg-red-600 hover:bg-red-500 rounded-md"><i class="fas fa-times"></i></button>
              </div>`;
          notificationsList.appendChild(reqEl);
      });
  };

  const sendFriendRequest = async (friendId) => {
      if (!currentUser || !friendId || !currentUserProfile) return;
      
      const requestData = { from: currentUser.uid, username: currentUserProfile.username, avatar: currentUserProfile.avatar };
      const updates = {};
      updates[`/friend_requests/${friendId}/${currentUser.uid}`] = requestData;
      updates[`/sent_friend_requests/${currentUser.uid}/${friendId}`] = true;
      await db.ref().update(updates);
  };
  
  const acceptFriendRequest = async (requesterId) => {
    const updates = {};
    updates[`/users/${currentUser.uid}/contacts/${requesterId}`] = true;
    updates[`/users/${requesterId}/contacts/${currentUser.uid}`] = true;
    updates[`/friend_requests/${currentUser.uid}/${requesterId}`] = null;
    updates[`/sent_friend_requests/${requesterId}/${currentUser.uid}`] = null;
    await db.ref().update(updates);
    if(currentUserProfile.contacts) {
      currentUserProfile.contacts[requesterId] = true;
    }
  };
  
  const declineFriendRequest = async (requesterId) => {
    const updates = {};
    updates[`/friend_requests/${currentUser.uid}/${requesterId}`] = null;
    updates[`/sent_friend_requests/${requesterId}/${currentUser.uid}`] = null;
    await db.ref().update(updates);
  };

  // ---=== PRIVATE CHAT & CONTACTS LOGIC ===---
  const enterContactsScreen = () => {
      if (!currentUser || !currentUserProfile) return;
      showView('contacts');
      if (contactsListener) db.ref(`users/${currentUser.uid}/contacts`).off('value', contactsListener);
      
      contactsListener = db.ref(`users/${currentUser.uid}/contacts`).on('value', (contactSnapshot) => {
          const contactIds = Object.keys(contactSnapshot.val() || {});
          
          if (presenceListener) db.ref('presence').off('value', presenceListener);
          const presenceRef = db.ref('presence');
          presenceListener = presenceRef.on('value', (presenceSnapshot) => {
              
              if (notificationListener) db.ref(`notifications/${currentUser.uid}`).off('value', notificationListener);
              const notificationsRef = db.ref(`notifications/${currentUser.uid}`);
              notificationListener = notificationsRef.on('value', (notificationSnapshot) => {
                renderContactsList(contactIds, presenceSnapshot.val() || {}, notificationSnapshot.val() || {});
              });
          });
      });
  };

  const renderContactsList = async (contactIds, onlineUids, notifications) => {
      contactsList.innerHTML = '';
      if (contactIds.length === 0) {
        contactsList.innerHTML = `<p class="text-gray-500 text-center mt-8">Adicione amigos para começar.</p>`;
        return;
      }
      for (const friendId of contactIds) {
          const userSnap = await db.ref(`users/${friendId}`).once('value');
          const friendProfile = userSnap.val();
          if (!friendProfile) continue;
          
          const isOnline = onlineUids[friendId] === true;
          const hasUnread = notifications[friendId] === true;

          const contactEl = document.createElement('div');
          contactEl.className = 'flex items-center justify-between gap-4 p-3 rounded-lg hover:bg-cyan-500/20 cursor-pointer';
          contactEl.innerHTML = `
            <div class="flex items-center gap-4">
                <img src="${friendProfile.avatar}" class="w-12 h-12 rounded-full">
                <div>
                    <p class="font-bold text-lg">${friendProfile.username}</p>
                    <p class="text-xs ${isOnline ? 'text-green-400 neon-text-green' : 'text-gray-500'}">${isOnline ? 'Online' : 'Offline'}</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                ${hasUnread ? '<div class="w-3 h-3 bg-red-600 rounded-full notification-dot"></div>' : ''}
                <i class="fas fa-comment-dots text-cyan-400"></i>
            </div>`;
          contactEl.addEventListener('click', () => startPrivateChat(friendId, friendProfile));
          contactsList.appendChild(contactEl);
      }
  };

  const leaveContactsScreen = () => {
    if (contactsListener) db.ref(`users/${currentUser.uid}/contacts`).off('value', contactsListener);
    if (presenceListener) db.ref('presence').off('value', presenceListener);
    if (notificationListener) db.ref(`notifications/${currentUser.uid}`).off('value', notificationListener);
  };

  const startPrivateChat = async (friendId, friendProfile) => {
      leaveContactsScreen();
      currentPrivateChatFriend = { id: friendId, ...friendProfile };
      privateChatRoomId = [currentUser.uid, friendId].sort().join('_');
      
      // Setup participant data for consistent message rendering
      chatParticipantData = {};
      chatParticipantData[currentUser.uid] = currentUserProfile;
      chatParticipantData[friendId] = friendProfile;

      privateChatPartnerAvatar.src = friendProfile.avatar;
      privateChatPartnerName.textContent = friendProfile.username;

      const friendStatusRef = db.ref(`presence/${friendId}`);
      presenceListener = friendStatusRef.on('value', snap => {
          privateChatPartnerStatus.textContent = snap.exists() ? 'Online' : 'Offline';
          privateChatPartnerStatus.className = `text-xs ${snap.exists() ? 'text-green-400 neon-text-green' : 'text-red-500 neon-text-red'}`;
      });
      
      db.ref(`notifications/${currentUser.uid}/${friendId}`).remove();
      
      privateChatContainer.innerHTML = '';
      const messagesRef = db.ref(`private_messages/${privateChatRoomId}/messages`).limitToLast(100);
      privateMessagesListener = messagesRef.on('child_added', snap => addMessageToUI(snap.val(), privateChatContainer, chatParticipantData));
      showView('private-chat');
  };

  const leavePrivateChat = () => {
      if (privateMessagesListener) db.ref(`private_messages/${privateChatRoomId}/messages`).off('child_added', privateMessagesListener);
      if (presenceListener && currentPrivateChatFriend) db.ref(`presence/${currentPrivateChatFriend.id}`).off('value', presenceListener);
      currentPrivateChatFriend = null; privateChatRoomId = null;
  };

  const sendPrivateMessage = (text) => {
      if (text.trim() === '' || !privateChatRoomId || !currentPrivateChatFriend) return;
      const messageData = { 
          senderId: currentUser.uid, 
          text: text, 
          isPremium: currentUserProfile.isPremium === true,
          timestamp: firebase.database.ServerValue.TIMESTAMP 
      };
      db.ref(`private_messages/${privateChatRoomId}/messages`).push(messageData);
      db.ref(`notifications/${currentPrivateChatFriend.id}/${currentUser.uid}`).set(true);
  };
  
  const sendMessage = (text) => {
    if (text.trim() === '' || !chatRoomId || !roomRef || !currentUser) return;
    const messageData = {
        senderId: currentUser.uid,
        text: text,
        isPremium: currentUserProfile.isPremium === true,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child('messages').push(messageData);
  };
  
  const addMessageToUI = (message, container, participants) => {
      if (!message || !currentUser || !container || !participants) return;
      const senderProfile = participants[message.senderId] || { username: 'Estranho', isPremium: message.isPremium };
      const isMe = message.senderId === currentUser.uid;
      const isVip = senderProfile.isPremium === true;

      const messageDiv = document.createElement('div');
      messageDiv.className = `flex flex-col fade-in ${isMe ? 'items-end' : 'items-start'}`;

      const usernameHTML = isVip 
          ? `<p class="text-xs mb-1 vip-name">${senderProfile.username} [VIP]</p>`
          : `<p class="text-xs mb-1 text-cyan-400">${senderProfile.username}</p>`;

      const bubbleClasses = isVip 
          ? 'vip-msg px-4 py-2 rounded-lg'
          : `px-4 py-2 rounded-lg ${isMe ? 'bg-cyan-800' : 'bg-gray-700'}`;
          
      messageDiv.innerHTML = `
          <div class="max-w-md">
              ${!isMe ? usernameHTML : ''}
              <div class="${bubbleClasses}">
                  <p class="text-sm break-words">${message.text}</p>
              </div>
          </div>`;
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
  };

  const addGlobalMessageToUI = (message) => {
      if (!message || !currentUser) return;
      const isMe = message.senderId === currentUser.uid;
      const isVip = message.isPremium === true;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex gap-3 my-2 ${isMe ? 'justify-end' : 'justify-start'}`;
      let contentHTML = message.type === 'audio' ? `<audio controls src="${message.text}" class="w-64"></audio>` : `<p class="text-sm break-words">${message.text}</p>`;
      
      const usernameHTML = isVip
          ? `<p class="text-xs mb-1 vip-name">${message.username} [VIP]</p>`
          : `<p class="text-xs mb-1 text-cyan-400">${message.username}</p>`;

      const bubbleClasses = isVip
          ? 'vip-msg px-4 py-2 rounded-lg'
          : `px-4 py-2 rounded-lg ${isMe ? 'bg-green-800/50 border border-green-500/50 neon-border-green' : 'bg-gray-700'}`;

      messageDiv.innerHTML = `
        ${!isMe ? `<img src="${message.avatar}" class="w-8 h-8 rounded-full self-end">` : ''}
        <div class="max-w-md">
            <div class="${isMe ? 'text-right' : 'text-left'}">${usernameHTML}</div>
            <div class="${bubbleClasses}">${contentHTML}</div>
        </div>
        ${isMe ? `<img src="${message.avatar}" class="w-8 h-8 rounded-full self-end">` : ''}`;
      globalChatContainer.appendChild(messageDiv);
      globalChatContainer.scrollTop = globalChatContainer.scrollHeight;
  };

  const sendGlobalMessage = (text, type = 'text') => {
      if ((!text || text.trim() === '') || !currentUserProfile) return;
      const messageData = {
          senderId: currentUser.uid,
          username: currentUserProfile.username,
          avatar: currentUserProfile.avatar,
          isPremium: currentUserProfile.isPremium === true,
          text: text,
          type: type,
          timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref('global_messages').push(messageData);
  };

  // ---=== ADMIN PANEL LOGIC ===---
  const enterAdminPanel = () => {
    showView('admin');
    const ticketsRef = db.ref('support_tickets');
    if (adminTicketsListener) ticketsRef.off('value', adminTicketsListener);

    adminTicketsListener = ticketsRef.on('value', snapshot => {
        const tickets = snapshot.val() || {};
        adminTicketsList.innerHTML = ''; // Clear list before rendering
        if (Object.keys(tickets).length === 0) {
            adminTicketsList.innerHTML = `<p class="text-gray-500 text-center">Nenhum ticket de suporte encontrado.</p>`;
            return;
        }
        
        // Sort tickets by timestamp, newest first
        const sortedTickets = Object.entries(tickets).sort(([, a], [, b]) => b.timestamp - a.timestamp);

        sortedTickets.forEach(([key, ticket]) => {
            const date = new Date(ticket.timestamp).toLocaleString('pt-BR');
            const ticketEl = document.createElement('div');
            ticketEl.className = 'bg-black/50 border border-gray-700 p-4 rounded-lg';
            ticketEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-lg font-bold text-cyan-400">${ticket.subject}</p>
                        <p class="text-sm text-gray-400">De: ${ticket.name} (${ticket.email})</p>
                        <p class="text-xs text-gray-500">Data: ${date}</p>
                    </div>
                    <span class="text-xs font-bold py-1 px-2 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500">NOVO</span>
                </div>
                <p class="mt-3 pt-3 border-t border-gray-700/50 text-gray-300">${ticket.description}</p>
            `;
            adminTicketsList.appendChild(ticketEl);
        });
    });
  };

  const leaveAdminPanel = () => {
      const ticketsRef = db.ref('support_tickets');
      if (adminTicketsListener) ticketsRef.off('value', adminTicketsListener);
      showView('home');
  };
  
  const uploadAudio = (blob) => { /* Unchanged */ };
  const toggleAudioRecording = async () => { /* Unchanged */ };


  // ---=== EVENT LISTENERS ===---
  enterVoidBtn.addEventListener('click', () => showView('login'));

  loginForm.addEventListener('submit', (e) => e.preventDefault());
  loginBtn.addEventListener('click', () => { setLoadingState(true, 'Entrando...'); auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value).catch(handleAuthError); });
  signupBtn.addEventListener('click', () => { setLoadingState(true, 'Criando conta...'); auth.createUserWithEmailAndPassword(emailInput.value.trim(), passwordInput.value).catch(handleAuthError); });
  googleSigninBtn.addEventListener('click', () => { setLoadingState(true, 'Aguardando Google...'); auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider()).catch(handleAuthError); });
  
  profileForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const profileData = { username: usernameInput.value.trim(), gender: genderSelect.value, region: regionSelect.value, interests: interestsInput.value.trim(), avatar: avatarInput.value.trim() };
    if (!Object.values(profileData).every(Boolean)) { fullProfileErrorEl.textContent = 'Preencha todos os campos.'; return; }
    fullProfileErrorEl.textContent = '';
    
    saveFullProfileBtn.disabled = true;
    saveFullProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>SALVANDO...';
    
    db.ref(`users/${currentUser.uid}`).update(profileData)
      .then(async () => {
          const wasFirstTimeSetup = !currentUserProfile;
          const contactsSnapshot = await db.ref(`users/${currentUser.uid}/contacts`).once('value');
          // Important: Preserve existing premium status when updating profile
          const isPremium = currentUserProfile ? currentUserProfile.isPremium : false;
          currentUserProfile = { ...profileData, isPremium, contacts: contactsSnapshot.val() || {} };

          updateUI(currentUserProfile);
          populateProfileModal(currentUserProfile);
          
          showProfileModal(false);

          if (wasFirstTimeSetup) {
            showView('home');
            managePresence(currentUser);
            listenForNotifications(currentUser);
            listenForFriendRequests(currentUser);
          }
      })
      .catch((err) => {
          console.error("Erro ao salvar perfil:", err);
          fullProfileErrorEl.textContent = 'Erro ao salvar.';
      })
      .finally(() => {
          saveFullProfileBtn.disabled = false;
          saveFullProfileBtn.innerHTML = 'SALVAR NO VAZIO';
      });
  });

  userProfileFooter.addEventListener('click', () => showProfileModal(true));
  
  randomChatExitBtn.addEventListener('click', () => { resetRandomChatState(); showView('home'); });
  
  matchBtn.addEventListener('click', async () => {
      if (!currentUserProfile) return;
      findPartner();
  });

  nextBtn.addEventListener('click', () => { resetRandomChatState(); findPartner(); });
  messageForm.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(messageInput.value); messageInput.value = ''; });

  globalChatCard.addEventListener('click', enterGlobalChat);
  globalChatBackBtn.addEventListener('click', leaveGlobalChat);
  globalMessageForm.addEventListener('submit', (e) => { e.preventDefault(); sendGlobalMessage(globalMessageInput.value, 'text'); globalMessageInput.value = ''; });
  globalOnlineUsersList.addEventListener('click', (e) => {
      const button = e.target.closest('.add-friend-btn');
      if (button && !button.disabled) sendFriendRequest(button.dataset.friendId);
  });

  privateChatCard.addEventListener('click', enterContactsScreen);
  contactsBackBtn.addEventListener('click', () => { leaveContactsScreen(); showView('home'); });
  privateChatBackBtn.addEventListener('click', () => { leavePrivateChat(); enterContactsScreen(); });
  privateMessageForm.addEventListener('submit', (e) => { e.preventDefault(); sendPrivateMessage(privateMessageInput.value); privateMessageInput.value = ''; });

  notificationsBtn.addEventListener('click', () => showNotificationsModal(true));
  notificationsCloseBtn.addEventListener('click', () => showNotificationsModal(false));
  notificationsList.addEventListener('click', e => {
      const acceptBtn = e.target.closest('.accept-request-btn');
      if(acceptBtn) acceptFriendRequest(acceptBtn.dataset.requesterId);
      const declineBtn = e.target.closest('.decline-request-btn');
      if(declineBtn) declineFriendRequest(declineBtn.dataset.requesterId);
  });
  
  // VIP Modal Listeners are paused
  vipModalCloseBtn.addEventListener('click', () => showVipModal(false));
  vipModal.addEventListener('click', (e) => {
    if (e.target === vipModal) {
      showVipModal(false);
    }
  });

  // Support Listeners
  supportFab.addEventListener('click', () => showSupportModal(true));
  supportModalCloseBtn.addEventListener('click', () => showSupportModal(false));
  supportForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const ticketData = {
        name: e.target.elements['support-name'].value,
        email: e.target.elements['support-email'].value,
        subject: e.target.elements['support-subject'].value,
        description: e.target.elements['support-description'].value,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        userId: currentUser ? currentUser.uid : 'anonymous'
    };

    db.ref('support_tickets').push(ticketData)
      .then(() => {
          alert('Chamado enviado com sucesso! Nossa equipe analisará.');
          supportForm.reset();
          showSupportModal(false);
      })
      .catch(err => {
          console.error("Support ticket error:", err);
          alert('Ocorreu um erro ao enviar seu chamado. Tente novamente.');
      });
  });

  // Admin Listeners
  adminBtn.addEventListener('click', enterAdminPanel);
  adminPanelBackBtn.addEventListener('click', leaveAdminPanel);

  window.addEventListener('beforeunload', () => {
    if(currentUser){
      if (sessionId) db.ref(`queue/${sessionId}`).remove();
      if (roomRef) roomRef.remove();
    }
  });
});
</script>

</body>
</html>