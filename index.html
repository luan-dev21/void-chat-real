<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VOID CHAT | O Vazio</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Orbitron', sans-serif; background-color: #000; color: #fff; }
    .neon-border-cyan { box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); border: 1px solid rgba(0, 255, 255, 0.4); }
    .neon-text-cyan { text-shadow: 0 0 10px #00ffff; }
    .neon-text-green { text-shadow: 0 0 10px #39FF14; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Background Animado */
    .stars {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(1px 1px at 20% 30%, #fff, transparent), radial-gradient(1px 1px at 70% 60%, #fff, transparent);
      background-size: 200px 200px; opacity: 0.3; z-index: 0;
    }
  </style>
</head>

<body class="w-screen h-screen overflow-hidden flex flex-col">
  <div class="stars"></div>

  <div id="login-screen" class="relative z-10 flex-1 flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-black/80 backdrop-blur-xl p-8 rounded-2xl neon-border-cyan text-center">
      <h1 class="text-4xl font-black neon-text-green mb-2">VOID CHAT</h1>
      <p class="text-cyan-400 text-sm mb-8 tracking-widest">ENTRE NO VAZIO</p>
      
      <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition-all">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5" alt="Google">
        Entrar com Google
      </button>
      
      <div id="login-status" class="mt-4 text-xs text-cyan-500 animate-pulse hidden">Conectando ao Vazio...</div>
    </div>
  </div>

  <div id="entry-screen" class="hidden relative z-10 flex-1 flex-col items-center justify-center text-center p-4">
    <h1 class="text-6xl font-black neon-text-green mb-4">VOID CHAT</h1>
    <div id="search-controls">
        <button id="enter-void-btn" class="px-12 py-4 border-2 border-cyan-500 text-cyan-400 font-bold rounded-full hover:bg-cyan-500 hover:text-black transition-all shadow-[0_0_20px_rgba(0,255,255,0.4)]">
            PROCURAR ESTRANHO
        </button>
    </div>
    <div id="searching-loader" class="hidden flex-col items-center gap-4">
        <div class="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-cyan-400 animate-pulse">ESCANEANDO O VAZIO...</p>
    </div>
  </div>

  <main id="chat-screen" class="hidden relative z-10 flex-1 flex flex-col md:flex-row h-full w-full bg-black">
    
    <aside class="hidden md:flex w-64 border-r border-cyan-900/50 p-4 flex-col gap-6 bg-black/50">
        <div class="text-center">
            <p class="text-xs text-gray-500">CONECTADO COMO</p>
            <p id="user-display-name" class="text-cyan-400 text-sm truncate">Anônimo</p>
        </div>
        <div class="flex-1 flex flex-col justify-center gap-4">
            <button class="w-full py-2 border border-purple-500 text-purple-500 text-xs rounded hover:bg-purple-500 hover:text-white transition-all">FILTRO VIP</button>
            <button id="next-btn-side" class="w-full py-3 bg-cyan-600 text-black font-bold rounded hover:bg-cyan-400">PRÓXIMO</button>
        </div>
        <button id="logout-btn" class="text-red-500 text-xs hover:underline">DESCONECTAR</button>
    </aside>

    <section class="flex-1 flex flex-col h-full relative">
        <header class="p-4 border-b border-cyan-900/50 flex justify-between items-center bg-black/80 backdrop-blur-md">
            <span class="text-green-500 text-xs flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> CONEXÃO ATIVA
            </span>
            <button id="next-btn-mobile" class="md:hidden px-4 py-1 bg-cyan-600 text-black text-xs font-bold rounded">PRÓXIMO</button>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
            </div>

        <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black via-black to-transparent">
            <form id="message-form" class="flex gap-2 max-w-4xl mx-auto">
                <input type="text" id="message-input" placeholder="Diga algo ao Vazio..." autocomplete="off" 
                    class="flex-1 bg-gray-900/80 border border-cyan-900 text-white px-4 py-3 rounded-lg focus:outline-none focus:border-cyan-400 transition-all">
                <button type="submit" class="bg-cyan-500 text-black px-6 rounded-lg font-bold hover:bg-cyan-400">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, onDisconnect, remove, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCJY8KnCAmegTJKgxk8Vb0fdDU64JV-zbU",
        authDomain: "meuchatreal.firebaseapp.com",
        databaseURL: "https://meuchatreal-default-rtdb.firebaseio.com",
        projectId: "meuchatreal",
        storageBucket: "meuchatreal.firebasestorage.app",
        messagingSenderId: "271430524108",
        appId: "1:271430524108:web:e23b8c36a188f150467669"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Variáveis de Estado
    let currentUser = null;
    let chatRoomId = null;
    let myQueueKey = null;

    // Elementos DOM
    const screens = {
        login: document.getElementById('login-screen'),
        entry: document.getElementById('entry-screen'),
        chat: document.getElementById('chat-screen')
    };

    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[name].classList.remove('hidden');
        if(name === 'chat') screens[name].classList.add('flex');
    }

    // --- LOGICA DE AUTH ---
    document.getElementById('google-signin-btn').onclick = () => {
        document.getElementById('login-status').classList.remove('hidden');
        signInWithRedirect(auth, new GoogleAuthProvider());
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('user-display-name').textContent = user.displayName || "Explorador";
            showScreen('entry');
        } else {
            showScreen('login');
        }
    });

    // --- LOGICA DE MATCHMAKING (FILA) ---
    async function findMatch() {
        if (!currentUser) return;
        
        document.getElementById('search-controls').classList.add('hidden');
        document.getElementById('searching-loader').classList.remove('hidden');

        const queueRef = ref(db, 'queue');
        
        // Tenta encontrar alguém na fila
        const matchmakingResult = await runTransaction(queueRef, (currentQueue) => {
            if (!currentQueue) return { [currentUser.uid]: true };
            
            const keys = Object.keys(currentQueue);
            const partnerId = keys.find(id => id !== currentUser.uid);

            if (partnerId) {
                // Remove o parceiro da fila para dar match
                delete currentQueue[partnerId];
                return currentQueue;
            } else {
                // Se ninguém, entra na fila
                currentQueue[currentUser.uid] = true;
                return currentQueue;
            }
        });

        // O Firebase Transaction não retorna diretamente o parceiro, então ouvimos a criação da sala
        listenForMatch();
    }

    function listenForMatch() {
        const roomsRef = ref(db, 'rooms');
        onValue(roomsRef, (snapshot) => {
            snapshot.forEach((child) => {
                const roomData = child.val();
                if (roomData.users && roomData.users[currentUser.uid]) {
                    chatRoomId = child.key;
                    startChat();
                }
            });
        });

        // Fallback: Adiciona na fila se não achou sala imediata
        set(ref(db, `queue/${currentUser.uid}`), true);
        onDisconnect(ref(db, `queue/${currentUser.uid}`)).remove();
    }

    // --- LOGICA DE CHAT ---
    function startChat() {
        showScreen('chat');
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '<p class="text-center text-xs text-cyan-700 neon-text-cyan py-4">SISTEMA: Estranho conectado.</p>';
        
        const messagesRef = ref(db, `rooms/${chatRoomId}/messages`);
        onValue(messagesRef, (snapshot) => {
            chatContainer.innerHTML = '';
            snapshot.forEach((msg) => {
                const data = msg.val();
                const isMe = data.sender === currentUser.uid;
                
                const div = document.createElement('div');
                div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} animate-fade-in`;
                div.innerHTML = `
                    <div class="${isMe ? 'bg-cyan-600 text-black' : 'bg-gray-800 text-white'} px-4 py-2 rounded-2xl max-w-[80%] break-words shadow-lg">
                        ${data.text}
                    </div>
                `;
                chatContainer.appendChild(div);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // Se o outro sair, a sala morre
        onDisconnect(ref(db, `rooms/${chatRoomId}`)).remove();
    }

    // --- EVENTOS ---
    document.getElementById('enter-void-btn').onclick = findMatch;
    
    document.getElementById('message-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        if (!input.value.trim() || !chatRoomId) return;

        const messagesRef = ref(db, `rooms/${chatRoomId}/messages`);
        push(messagesRef, {
            sender: currentUser.uid,
            text: input.value,
            time: serverTimestamp()
        });
        input.value = '';
    };

    const nextAction = () => {
        if(chatRoomId) remove(ref(db, `rooms/${chatRoomId}`));
        location.reload(); // Jeito mais limpo de resetar a fila e buscar novo
    };

    document.getElementById('next-btn-side').onclick = nextAction;
    document.getElementById('next-btn-mobile').onclick = nextAction;
    document.getElementById('logout-btn').onclick = () => signOut(auth);

  </script>
</body>
</html>