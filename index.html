<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VOID CHAT</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDKs CDN (Compat Version 9.6.1) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  
  <!-- Font Awesome CDN for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Google Fonts: Orbitron -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      overflow: hidden;
    }
    .neon-border-cyan {
      box-shadow: 0 0 3px rgba(0, 255, 255, 0.8), 0 0 5px rgba(0, 255, 255, 0.6), 0 0 10px rgba(0, 255, 255, 0.4);
    }
    .neon-border-green {
      box-shadow: 0 0 3px rgba(57, 255, 20, 0.8), 0 0 5px rgba(57, 255, 20, 0.6), 0 0 10px rgba(57, 255, 20, 0.4);
    }
    .neon-border-gold {
      box-shadow: 0 0 3px rgba(255, 215, 0, 0.8), 0 0 5px rgba(255, 215, 0, 0.6), 0 0 10px rgba(255, 215, 0, 0.4);
    }
    .neon-text-cyan {
      text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
    }
    .neon-text-green {
       text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14;
    }
    .neon-text-red {
       text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000;
    }
    .neon-text-gold {
        text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700;
    }
    .neon-button-glow {
      transition: all 0.2s ease-in-out;
    }
    .neon-button-glow:hover {
      box-shadow: 0 0 5px #00ffff, 0 0 15px #00ffff, 0 0 25px #00ffff;
    }
    .vip-name {
      color: #FFD700;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
      font-weight: bold;
    }
    .vip-msg {
      border-left: 3px solid #FFD700;
      background: rgba(255, 215, 0, 0.05);
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 2px #39FF14, 0 0 4px #39FF14; }
      50% { box-shadow: 0 0 6px #39FF14, 0 0 12px #39FF14; }
    }
     @keyframes pulse-red {
      0%, 100% { text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
      50% { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000; }
    }
    @keyframes pulse-red-dot {
        0%, 100% { box-shadow: 0 0 3px #ff0000, 0 0 5px #ff0000; }
        50% { box-shadow: 0 0 8px #ff0000, 0 0 12px #ff0000; }
    }
    .pulse-dot {
      animation: pulse-green 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
    }
     .recording-active {
        animation: pulse-red 1.5s infinite;
        color: #ff0000;
    }
    .notification-dot {
        animation: pulse-red-dot 1.5s infinite;
    }
    @keyframes pulse-premium {
        0%, 100% { box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7; }
        50% { box-shadow: 0 0 15px #a855f7, 0 0 25px #a855f7; }
    }
     @keyframes pulse-cyan-button {
      0%, 100% { box-shadow: 0 0 4px #00ffff, 0 0 8px #00ffff; transform: scale(1); }
      50% { box-shadow: 0 0 12px #00ffff, 0 0 24px #00ffff; transform: scale(1.02); }
    }
    .neon-pulse-cyan {
        animation: pulse-cyan-button 2.5s infinite;
    }
    .neon-premium-glow {
        animation: pulse-premium 2.5s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    .animated-stars {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: 
        radial-gradient(1px 1px at 20% 30%, #fff, transparent), radial-gradient(1px 1px at 80% 10%, #fff, transparent),
        radial-gradient(1px 1px at 50% 70%, #fff, transparent), radial-gradient(2px 2px at 90% 80%, #fff, transparent),
        radial-gradient(2px 2px at 10% 90%, #fff, transparent);
      background-repeat: repeat; background-size: 300px 300px; animation: zoom 15s infinite alternate; opacity: 0.5;
    }
    @keyframes zoom {
      from { transform: scale(1); }
      to { transform: scale(1.2); }
    }
    /* Hide scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* VIP Modal Styles */
    @keyframes premium-border-glow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .animated-premium-border {
        position: relative;
        padding: 3px;
        background-color: #000;
        z-index: 1;
    }
    .animated-premium-border::before {
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
        z-index: -1;
        margin: -3px; /* equal to padding */
        border-radius: inherit; /* inherit container's border-radius */
        background: linear-gradient(90deg, #a855f7, #ffd700, #a855f7);
        background-size: 200% 200%;
        animation: premium-border-glow 4s linear infinite;
    }
    .admin-filter-btn.active {
        background-color: #00ffff;
        color: black;
        box-shadow: 0 0 10px #00ffff;
    }
  </style>
</head>

<body class="bg-black text-white w-screen h-screen overflow-hidden">
  <div class="animated-stars"></div>

  <!-- Loading Overlay (Global) -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex-col items-center justify-center z-50">
    <div class="w-16 h-16 border-4 border-dashed border-cyan-500 rounded-full animate-spin"></div>
    <p id="loading-msg" class="text-xl text-cyan-400 tracking-wider mt-4">Verificando login...</p>
  </div>

  <!-- Landing Screen -->
  <div id="landing-screen" class="hidden w-full h-full flex-col items-center justify-center p-4 relative z-10">
      <div class="text-center space-y-8">
          <h1 class="text-7xl md:text-9xl font-black text-white neon-text-green tracking-widest">VOID CHAT</h1>
          <button id="enter-void-btn" class="text-2xl font-bold py-4 px-10 rounded-md text-black bg-cyan-400 border-2 border-cyan-200 neon-pulse-cyan transition-all uppercase">
              [ Entrar no Vazio ]
          </button>
      </div>
  </div>


  <!-- Login Screen -->
  <div id="login-screen" class="hidden w-full h-full flex items-center justify-center p-4 relative z-10">
    <div class="w-full max-w-md bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-8 neon-border-cyan space-y-6">
      <div class="text-center">
        <h1 class="text-4xl font-black text-white neon-text-green">VOID CHAT</h1>
        <p class="text-cyan-400 neon-text-cyan text-sm">Acesse o Vazio.</p>
      </div>
      <form id="login-form" class="space-y-4">
        <div>
          <label for="email" class="block text-cyan-400 text-sm mb-1">Email</label>
          <input type="email" id="email" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
        </div>
        <div>
          <label for="password" class="block text-cyan-400 text-sm mb-1">Senha</label>
          <input type="password" id="password" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
        </div>
        <p id="auth-error" class="text-red-500 text-xs text-center h-4"></p>
        <div class="space-y-2">
            <button type="submit" id="login-btn" class="w-full font-bold py-2 px-4 rounded-md text-white bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 transition-all">Entrar</button>
            <button type="button" id="signup-btn" class="w-full font-bold py-2 px-4 rounded-md text-cyan-400 border-2 border-cyan-400 hover:bg-cyan-400 hover:text-black transition-all">Criar Conta</button>
        </div>
      </form>
      <div class="flex items-center text-gray-500">
        <hr class="flex-grow border-gray-700" />
        <span class="px-2 text-xs">OU</span>
        <hr class="flex-grow border-gray-700" />
      </div>
       <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 font-sans font-medium py-2 px-4 rounded-md text-black bg-white hover:bg-gray-200 transition-all">
          <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
          Entrar com Google
      </button>
    </div>
  </div>

  <!-- Profile Creation Modal -->
  <div id="profile-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
      <div class="w-full max-w-lg bg-black/50 border border-cyan-500 rounded-lg p-8 neon-border-cyan space-y-6">
          <div class="text-center">
              <h1 class="text-3xl font-bold text-white neon-text-green">COMPLETE SEU PERFIL</h1>
              <p class="text-cyan-400 neon-text-cyan text-sm">Sua identidade para mergulhar no Vazio.</p>
          </div>
          <form id="profile-form" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label for="username-input" class="block text-cyan-400 text-sm mb-1">Username</label>
                      <input type="text" id="username-input" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                  </div>
                  <div>
                      <label for="gender-select" class="block text-cyan-400 text-sm mb-1">Sexo</label>
                      <select id="gender-select" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                          <option value="">Selecione...</option>
                          <option value="Masculino">Masculino</option>
                          <option value="Feminino">Feminino</option>
                          <option value="Outro">Outro</option>
                      </select>
                  </div>
                  <div>
                      <label for="region-select" class="block text-cyan-400 text-sm mb-1">Região (Estado)</label>
                      <select id="region-select" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                        <!-- Options will be populated by JS -->
                      </select>
                  </div>
                   <div>
                      <label for="interests-input" class="block text-cyan-400 text-sm mb-1">Interesses</label>
                      <input type="text" id="interests-input" placeholder="Games, Música, etc" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                  </div>
              </div>
               <div>
                  <label for="avatar-input" class="block text-cyan-400 text-sm mb-1">URL da Foto de Perfil / Avatar</label>
                  <input type="url" id="avatar-input" placeholder="https://exemplo.com/imagem.png" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
              </div>

              <p id="full-profile-error" class="text-red-500 text-xs text-center h-4"></p>
              <button type="submit" id="save-full-profile-btn" class="w-full font-bold py-3 px-4 rounded-md text-black bg-cyan-400 neon-button-glow transition-all text-lg">SALVAR NO VAZIO</button>
          </form>
      </div>
  </div>

  <!-- Home Screen -->
    <div id="home-screen" class="hidden w-full h-full flex flex-col justify-center items-center p-4 relative z-10">
        <div class="text-center mb-12">
            <h1 class="text-6xl md:text-8xl font-black text-white neon-text-green tracking-widest">VOID CHAT</h1>
            <p class="text-cyan-400 mt-4 neon-text-cyan">ESCOLHA SEU CAMINHO NO VAZIO.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-4xl">
            <!-- Card 1: Global Chat -->
            <div id="global-chat-card" class="bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-900/50 transition-all cursor-pointer">
                <i class="fas fa-globe text-4xl text-cyan-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">CHAT GLOBAL</h2>
                <p class="text-gray-400 text-sm mt-2">Converse com todos os usuários online em uma única sala.</p>
            </div>

            <!-- Card 2: Random Void (Matchmaking) -->
            <div id="match-btn" class="bg-white/5 backdrop-blur-md border-2 border-cyan-400 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-800/60 transition-all cursor-pointer transform hover:scale-105">
                <i class="fas fa-random text-4xl text-cyan-300 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">RANDOM VOID</h2>
                <p class="text-gray-300 text-sm mt-2">Mergulhe no desconhecido e encontre uma conexão anônima aleatória.</p>
            </div>

            <!-- Card 3: Private Chat -->
            <div id="private-chat-card" class="relative bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 text-center neon-border-cyan hover:bg-cyan-900/50 transition-all cursor-pointer">
                <div id="private-chat-notification" class="hidden absolute top-3 right-3 w-4 h-4 bg-red-600 rounded-full border-2 border-black notification-dot"></div>
                <i class="fas fa-user-secret text-4xl text-cyan-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white">CHAT PRIVADO</h2>
                <p class="text-gray-400 text-sm mt-2">Inicie conversas diretas com seus contatos.</p>
            </div>
        </div>

        <footer class="absolute bottom-0 left-0 right-0 p-4 bg-black/50 border-t border-cyan-500/20 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div id="user-profile-footer" class="flex items-center gap-3 cursor-pointer group">
                    <img id="user-avatar-home" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-cyan-400 group-hover:border-white transition-all">
                    <div>
                        <p id="user-name-home" class="font-bold text-white group-hover:text-cyan-300 transition-all">Carregando...</p>
                        <p id="user-region-home" class="text-xs text-gray-400">...</p>
                    </div>
                </div>
                <div class="relative">
                    <button id="notifications-btn" class="text-2xl text-cyan-400 hover:text-white transition-colors">
                        <i class="fas fa-bell"></i>
                    </button>
                    <span id="friend-request-notification" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-600 rounded-full border-2 border-black notification-dot"></span>
                </div>
                <div class="relative">
                    <button id="my-tickets-btn" class="text-2xl text-cyan-400 hover:text-white transition-colors">
                        <i class="fas fa-headset"></i>
                    </button>
                    <span id="ticket-notification" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-600 rounded-full border-2 border-black notification-dot"></span>
                </div>
                 <button id="admin-btn" class="hidden ml-4 font-bold py-1 px-3 rounded-md text-black bg-green-500 border border-green-300 neon-border-green">
                    <i class="fas fa-shield-halved mr-1"></i>PAINEL ADMIN
                </button>
            </div>
            <button id="premium-btn" class="font-bold py-2 px-5 rounded-md text-white bg-purple-600 border border-purple-400 neon-premium-glow">
                <i class="fas fa-star mr-2"></i>ATIVAR PREMIUM
            </button>
        </footer>
    </div>


  <!-- Scanning Screen (Simplified) -->
  <div id="entry-screen" class="hidden w-full h-full flex-col items-center justify-center p-4 text-center relative z-10">
    <div id="scanning-content" class="flex-col items-center justify-center space-y-4">
      <div class="w-16 h-16 border-4 border-dashed border-cyan-500 rounded-full animate-spin"></div>
      <p class="text-xl text-cyan-400 tracking-wider">BUSCANDO CONEXÃO REAL...</p>
    </div>
  </div>

  <!-- Chat Screen (1-on-1 Random) -->
  <main id="chat-screen" class="hidden w-full h-screen p-4 flex gap-4 font-orbitron bg-black relative overflow-hidden z-10">
    <!-- Left Sidebar -->
    <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
      <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center border-b border-cyan-500/30 pb-2">STATUS</h2>
      <div class="flex-grow flex flex-col justify-center items-center text-center">
        <div class="relative flex items-center justify-center w-24 h-24 mb-4">
          <div class="absolute inset-0 bg-green-500/50 rounded-full animate-ping"></div>
          <img id="my-avatar-chat" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" class="w-20 h-20 rounded-full border-2 border-cyan-300 z-10">
        </div>
        <p class="text-2xl font-bold text-green-400 neon-text-green">ONLINE</p>
        <p class="text-sm text-gray-400">Você está conectado ao Vazio.</p>
      </div>
       <div class="text-center border-t border-cyan-500/30 pt-4 space-y-3">
          <div>
            <p id="online-users" class="text-lg text-white">1</p>
            <p class="text-sm text-cyan-400 neon-text-cyan flex items-center justify-center gap-2">
              <span class="w-3 h-3 bg-green-400 rounded-full pulse-dot"></span>
              HUMANOS CONECTADOS
            </p>
          </div>
          <button id="random-chat-exit-btn" class="w-full p-2 bg-red-800/50 hover:bg-red-700/50 border border-red-500/50 rounded-md transition-colors text-sm">
            <i class="fas fa-sign-out-alt mr-2"></i>SAIR DA SALA
          </button>
      </div>
    </aside>

    <!-- Center Chat -->
    <section class="w-1/2 h-full flex flex-col bg-black/50 border border-gray-700/50 rounded-lg overflow-hidden z-10">
        <header class="p-3 border-b border-gray-700/50 text-center flex items-center gap-4 justify-center">
          <img id="partner-avatar-chat" src="https://i.pravatar.cc/150?u=a042581f4e29026704e" class="w-10 h-10 rounded-full border-2 border-gray-500">
          <div>
            <h3 id="partner-name" class="font-bold text-lg text-white">CONEXÃO ESTABELECIDA</h3>
            <p id="partner-info" class="text-xs text-gray-400">Você está conversando com um estranho.</p>
          </div>
        </header>
        <div id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
          <!-- Messages will be injected here -->
        </div>
        <footer class="p-3 border-t border-gray-700/50 bg-black/50">
          <form id="message-form" class="flex items-center gap-3">
            <input type="text" id="message-input" placeholder="Digite no Vazio..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
            <button type="submit" id="send-btn" class="bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-700 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-md transition-colors">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </footer>
    </section>

    <!-- Right Sidebar -->
    <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
      <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center border-b border-cyan-500/30 pb-2">ÁREA VIP</h2>
      <div class="flex-grow flex flex-col justify-center gap-4">
          <button class="w-full text-center p-4 border-2 border-cyan-400 rounded-md neon-button-glow hover:bg-cyan-400 hover:text-black transition-all">
            <p class="font-bold text-lg">ATIVAR FILTRO DE GÊNERO</p>
            <p class="text-xs font-sans">REQUER ASSINATURA VIP</p>
          </button>
          <button class="w-full text-center p-4 border-2 border-purple-500 text-purple-400 rounded-md neon-button-glow hover:bg-purple-500 hover:text-black transition-all">
            <p class="font-bold text-lg">TURBO MATCH</p>
            <p class="text-xs font-sans">CONEXÃO IMEDIATA</p>
          </button>
      </div>
      <button id="next-btn" class="w-full p-3 bg-gray-700 hover:bg-gray-600 border border-gray-500 rounded-md transition-colors">
        PRÓXIMO
      </button>
    </aside>
  </main>

    <!-- Global Chat Screen -->
    <main id="global-chat-screen" class="hidden w-full h-screen p-4 flex gap-4 font-orbitron bg-black relative overflow-hidden z-10">
        <!-- Left Sidebar - Online Users -->
        <aside class="w-1/4 h-full flex flex-col gap-4 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-4 neon-border-cyan z-10">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-2">
                 <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan text-center">ONLINE</h2>
                 <button id="global-chat-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </button>
            </div>
            <div id="global-online-users-list" class="flex-grow overflow-y-auto space-y-1 no-scrollbar pr-2">
                <!-- User list will be populated here -->
            </div>
        </aside>

        <!-- Center Chat -->
        <section class="w-3/4 h-full flex flex-col bg-black/50 border border-gray-700/50 rounded-lg overflow-hidden z-10">
            <header class="p-3 border-b border-gray-700/50 text-center">
                <h3 class="font-bold text-lg text-white neon-text-cyan">CHAT GLOBAL</h3>
                <p class="text-xs text-gray-400">Todos os humanos conectados no Vazio.</p>
            </header>
            <div id="global-chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
                <!-- Global messages will be injected here -->
            </div>
            <footer class="p-3 border-t border-gray-700/50 bg-black/50">
                <form id="global-message-form" class="flex items-center gap-3">
                    <input type="text" id="global-message-input" placeholder="Converse com o mundo..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
                    <button type="button" id="record-audio-btn" class="text-cyan-400 hover:text-white text-xl px-3 transition-colors">
                      <i class="fas fa-microphone"></i>
                    </button>
                    <button type="submit" id="global-send-btn" class="bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-700 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </footer>
        </section>
    </main>
    
    <!-- Contacts Screen -->
    <div id="contacts-screen" class="hidden w-full h-full flex flex-col justify-center items-center p-4 relative z-10">
        <div class="w-full max-w-2xl h-4/5 bg-white/5 backdrop-blur-md border border-cyan-500/30 rounded-lg p-6 neon-border-cyan flex flex-col">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-3 mb-4">
                <h2 class="text-3xl font-bold text-cyan-400 neon-text-cyan">CONTATOS</h2>
                <button id="contacts-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                   <i class="fas fa-times fa-lg"></i>
               </button>
           </div>
           <div id="contacts-list" class="flex-grow overflow-y-auto space-y-2 no-scrollbar pr-2">
               <!-- Contacts list will be populated here -->
           </div>
        </div>
    </div>

    <!-- Private Chat Screen -->
    <main id="private-chat-screen" class="hidden w-full h-screen p-4 flex justify-center items-center font-orbitron bg-black relative overflow-hidden z-10">
        <section class="w-full max-w-3xl h-5/6 flex flex-col bg-black/50 border border-cyan-500/50 neon-border-cyan rounded-lg overflow-hidden z-10">
            <header class="p-3 border-b border-cyan-500/50 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img id="private-chat-partner-avatar" src="https://i.pravatar.cc/150?u=a042581f4e29026704e" class="w-10 h-10 rounded-full border-2 border-gray-500">
                    <div>
                      <h3 id="private-chat-partner-name" class="font-bold text-lg text-white">Carregando...</h3>
                      <p id="private-chat-partner-status" class="text-xs text-red-500 neon-text-red">Offline</p>
                    </div>
                </div>
                <button id="private-chat-back-btn" class="text-cyan-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </button>
            </header>
            <div id="private-chat-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
                <!-- Private messages will be injected here -->
            </div>
            <footer class="p-3 border-t border-cyan-500/50 bg-black/50">
                <form id="private-message-form" class="flex items-center gap-3">
                    <input type="text" id="private-message-input" placeholder="Envie uma mensagem privada..." autocomplete="off" class="flex-1 bg-black/50 border border-cyan-500/50 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white transition-all">
                    <button type="submit" id="private-send-btn" class="bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </footer>
        </section>
    </main>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
        <div class="w-full max-w-md h-auto max-h-[80vh] bg-black/50 border border-cyan-500 rounded-lg p-6 neon-border-cyan flex flex-col">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-3 mb-4">
                <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan">NOTIFICAÇÕES</h2>
                <button id="notifications-close-btn" class="text-cyan-400 hover:text-white transition-colors">
                   <i class="fas fa-times fa-lg"></i>
               </button>
           </div>
           <div id="notifications-list" class="flex-grow overflow-y-auto space-y-3 no-scrollbar pr-2">
               <!-- Friend requests will be populated here -->
           </div>
        </div>
    </div>

    <!-- VOID VIP Upgrade Modal -->
    <div id="vip-modal" class="hidden absolute inset-0 bg-black/80 backdrop-blur-xl items-center justify-center p-4 z-50">
      <div class="w-full max-w-lg rounded-lg animated-premium-border">
          <div class="relative bg-black/90 p-8 rounded-lg">
              <button id="vip-modal-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-20">
                  <i class="fas fa-times fa-2x"></i>
              </button>
              <div class="text-center mb-6">
                  <h2 class="text-3xl font-black text-white" style="text-shadow: 0 0 8px #a855f7;">UPGRADE DE SISTEMA</h2>
                  <p class="text-4xl font-black text-purple-400" style="text-shadow: 0 0 5px #a855f7, 0 0 10px #ffd700;">VOID VIP</p>
              </div>
              <ul class="space-y-4 text-lg mb-8">
                  <li class="flex items-center gap-4"><i class="fas fa-gem w-6 text-center text-yellow-400 neon-text-gold"></i><span><span class="font-bold">Nome Dourado + Selo VIP:</span> Destaque-se em todos os chats.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-infinity w-6 text-center text-yellow-400 neon-text-gold"></i><span><span class="font-bold">Matching Sem Limites:</span> Encontre novas conexões sem restrições.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-users w-6 text-center text-yellow-400 neon-text-gold"></i><span><span class="font-bold">Amigos Ilimitados:</span> Adicione quantos amigos quiser.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-microphone-alt w-6 text-center text-purple-400" style="text-shadow: 0 0 6px #a855f7;"></i><span><span class="font-bold">Áudios Ilimitados:</span> Envie quantos áudios quiser.</span></li>
                  <li class="flex items-center gap-4"><i class="fas fa-shield-alt w-6 text-center text-purple-400" style="text-shadow: 0 0 6px #a855f7;"></i><span><span class="font-bold">Sem Anúncios:</span> Experiência limpa no Vazio.</span></li>
              </ul>
              <button id="vip-modal-action-btn" class="w-full font-bold py-4 px-4 rounded-md text-black bg-purple-500 border-2 border-purple-300 transition-all text-xl uppercase tracking-widest neon-premium-glow hover:bg-purple-400">
                  Adquirir Acesso Agora
              </button>
          </div>
      </div>
    </div>
    
    <!-- Support Modal (Create Ticket) -->
    <div id="support-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
        <div class="w-full max-w-lg bg-black/50 border border-cyan-500 rounded-lg p-8 neon-border-cyan space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-white neon-text-cyan">ABRIR CHAMADO</h1>
                <button id="support-modal-close-btn" class="text-cyan-400 hover:text-white transition-colors">
                   <i class="fas fa-times fa-lg"></i>
               </button>
            </div>
            <form id="support-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="support-name" class="block text-cyan-400 text-sm mb-1">Nome</label>
                        <input type="text" id="support-name" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                    </div>
                    <div>
                        <label for="support-email" class="block text-cyan-400 text-sm mb-1">E-mail</label>
                        <input type="email" id="support-email" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all" />
                    </div>
                </div>
                <div>
                    <label for="support-subject" class="block text-cyan-400 text-sm mb-1">Tipo de Problema</label>
                    <select id="support-subject" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all">
                        <option value="Bug">Bug</option>
                        <option value="Sugestão">Sugestão</option>
                        <option value="Esqueci Senha">Esqueci Senha</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="support-description" class="block text-cyan-400 text-sm mb-1">Descrição</label>
                    <textarea id="support-description" rows="4" required class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all"></textarea>
                </div>
                <button type="submit" id="support-submit-btn" class="w-full font-bold py-3 px-4 rounded-md text-black bg-cyan-400 neon-button-glow transition-all text-lg">ENVIAR CHAMADO</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden w-full h-full flex-col p-4 relative z-20">
        <div class="flex items-center justify-between border-b border-green-500/30 pb-3 mb-4">
            <h2 class="text-3xl font-bold text-green-400 neon-text-green">PAINEL ADMIN - TICKETS</h2>
            <button id="admin-panel-back-btn" class="text-green-400 hover:text-white transition-colors">
               <i class="fas fa-arrow-left fa-lg mr-2"></i> VOLTAR
           </button>
       </div>
       <div id="admin-filters" class="flex items-center gap-2 mb-4">
            <button data-filter="Pendentes" class="admin-filter-btn font-bold py-1 px-3 rounded-md text-cyan-400 border border-cyan-400 hover:bg-cyan-400 hover:text-black transition-all active">Pendentes</button>
            <button data-filter="Resolvido" class="admin-filter-btn font-bold py-1 px-3 rounded-md text-cyan-400 border border-cyan-400 hover:bg-cyan-400 hover:text-black transition-all">Resolvidos</button>
       </div>
       <div id="admin-tickets-list" class="flex-grow overflow-y-auto space-y-4 no-scrollbar pr-2">
           <!-- Tickets will be populated here -->
       </div>
    </div>
    
    <!-- User Tickets Modal (List View) -->
    <div id="user-tickets-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-40">
        <div class="w-full max-w-2xl h-auto max-h-[80vh] bg-black/50 border border-cyan-500 rounded-lg p-6 neon-border-cyan flex flex-col">
            <div class="flex items-center justify-between border-b border-cyan-500/30 pb-3 mb-4">
                <h2 class="text-2xl font-bold text-cyan-400 neon-text-cyan">MEUS CHAMADOS</h2>
                <div class="flex items-center gap-4">
                    <button id="open-new-ticket-btn" class="font-bold py-1 px-3 rounded-md text-black bg-cyan-400 neon-button-glow transition-all">NOVO CHAMADO</button>
                    <button id="user-tickets-close-btn" class="text-cyan-400 hover:text-white transition-colors">
                       <i class="fas fa-times fa-lg"></i>
                   </button>
                </div>
           </div>
           <div id="user-tickets-list" class="flex-grow overflow-y-auto space-y-3 no-scrollbar pr-2">
               <!-- User tickets list will be populated here -->
           </div>
        </div>
    </div>

    <!-- Ticket Chat Modal (Used by Admin and User) -->
    <div id="ticket-chat-modal" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 z-50">
        <div id="ticket-chat-modal-content" class="w-full max-w-2xl h-[90vh] bg-black/50 border rounded-lg flex flex-col">
            <!-- Header -->
            <div id="ticket-chat-modal-header" class="p-4 border-b flex justify-between items-center">
                <div>
                    <h2 id="ticket-chat-modal-subject" class="text-xl font-bold"></h2>
                    <p id="ticket-chat-modal-status" class="text-sm"></p>
                </div>
                <button id="ticket-chat-modal-close-btn" class="text-2xl">&times;</button>
            </div>
            <!-- Messages -->
            <div id="ticket-chat-messages-container" class="flex-1 p-4 overflow-y-auto space-y-4 no-scrollbar">
                <!-- Messages will be injected here -->
            </div>
            <!-- Controls -->
            <div class="p-4 border-t">
                <!-- Admin Controls -->
                <div id="ticket-chat-admin-controls" class="hidden mb-4 p-3 border border-gray-600 rounded-lg">
                    <label for="ticket-chat-status-select" class="block text-sm mb-1">Alterar Status</label>
                    <select id="ticket-chat-status-select" class="w-full bg-black/50 border border-gray-700 rounded-md py-2 px-3">
                        <option value="Aberto">Aberto</option>
                        <option value="Aguardando Admin">Aguardando Admin</option>
                        <option value="Aguardando Retorno do Cliente">Aguardando Retorno do Cliente</option>
                        <option value="Resolvido">Resolvido</option>
                    </select>
                </div>
                <!-- Message Form -->
                <form id="ticket-chat-form">
                    <input type="hidden" id="ticket-chat-id">
                    <div class="flex items-center gap-3">
                        <input type="text" id="ticket-chat-message-input" placeholder="Digite sua mensagem..." autocomplete="off" class="flex-1 bg-black/50 border rounded-md py-2 px-4 focus:outline-none focus:ring-2 text-white transition-all">
                        <button type="submit" id="ticket-chat-send-btn" class="font-bold py-2 px-4 rounded-md transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                <!-- User Controls -->
                 <div id="ticket-chat-user-controls" class="hidden mt-4">
                    <button id="ticket-chat-delete-btn" class="w-full text-sm py-2 px-4 rounded-md bg-red-800/60 hover:bg-red-700/60 border border-red-500/50 text-red-300 transition-colors">Apagar Chamado</button>
                </div>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

  // ---=== GLOBAL VARIABLES & CONFIG ===---
  const ADMIN_UID = 'lxWxEwMGCee1Hcu01qIdHydafQf2';
  const firebaseConfig = {
    apiKey: "AIzaSyCJY8KnCAmegTJKgxk8Vb0fdDU64JV-zbU",
    authDomain: "meuchatreal.firebaseapp.com",
    databaseURL: "https://meuchatreal-default-rtdb.firebaseio.com",
    projectId: "meuchatreal",
    storageBucket: "meuchatreal.appspot.com",
    messagingSenderId: "271430524108",
    appId: "1:271430524108:web:e23b8c36a188f150467669"
  };

  // State Variables
  let db, auth, storage;
  let currentUser = null;
  let currentUserProfile = null;
  let adminTicketsListener = null;
  let currentAdminTicketData = null;
  let userTicketsListener = null;
  let ticketRepliesListener = null;
  let currentTicketChatListener = null;
  let matchMakingListener = null;
  let chatRoomId = null;
  let partnerId = null;
  let roomRef = null;
  let messagesListener = null;
  let roomValueListener = null;
  let globalMessagesListener = null;
  let globalOnlineListener = null;
  let mediaRecorder = null;
  let audioChunks = [];
  let currentPrivateChatFriend = null;
  let privateChatRoomId = null;
  let privateMessagesListener = null;
  let contactsListener = null;
  let notificationListener = null;
  let friendRequestListener = null;
  
  // ---=== DOM ELEMENT DECLARATIONS (Full list) ===---
  const loadingOverlay = document.getElementById('loading-overlay'), loadingMsg = document.getElementById('loading-msg'),
        landingScreen = document.getElementById('landing-screen'), loginScreen = document.getElementById('login-screen'),
        profileModal = document.getElementById('profile-modal'), homeScreen = document.getElementById('home-screen'),
        entryScreen = document.getElementById('entry-screen'), chatScreen = document.getElementById('chat-screen'),
        globalChatScreen = document.getElementById('global-chat-screen'), contactsScreen = document.getElementById('contacts-screen'),
        privateChatScreen = document.getElementById('private-chat-screen'), notificationsModal = document.getElementById('notifications-modal'),
        vipModal = document.getElementById('vip-modal'), supportModal = document.getElementById('support-modal'),
        adminPanel = document.getElementById('admin-panel'), userTicketsModal = document.getElementById('user-tickets-modal'),
        ticketChatModal = document.getElementById('ticket-chat-modal');
  const enterVoidBtn = document.getElementById('enter-void-btn'), loginBtn = document.getElementById('login-btn'),
        signupBtn = document.getElementById('signup-btn'), googleSigninBtn = document.getElementById('google-signin-btn'),
        saveFullProfileBtn = document.getElementById('save-full-profile-btn'), randomChatExitBtn = document.getElementById('random-chat-exit-btn'),
        nextBtn = document.getElementById('next-btn'), globalChatBackBtn = document.getElementById('global-chat-back-btn'),
        contactsBackBtn = document.getElementById('contacts-back-btn'), privateChatBackBtn = document.getElementById('private-chat-back-btn'),
        notificationsBtn = document.getElementById('notifications-btn'), notificationsCloseBtn = document.getElementById('notifications-close-btn'),
        premiumBtn = document.getElementById('premium-btn'), vipModalCloseBtn = document.getElementById('vip-modal-close-btn'),
        vipModalActionBtn = document.getElementById('vip-modal-action-btn'), supportModalCloseBtn = document.getElementById('support-modal-close-btn'), 
        myTicketsBtn = document.getElementById('my-tickets-btn'), userTicketsCloseBtn = document.getElementById('user-tickets-close-btn'),
        openNewTicketBtn = document.getElementById('open-new-ticket-btn'), adminBtn = document.getElementById('admin-btn'),
        adminPanelBackBtn = document.getElementById('admin-panel-back-btn'), ticketChatModalCloseBtn = document.getElementById('ticket-chat-modal-close-btn'),
        ticketChatDeleteBtn = document.getElementById('ticket-chat-delete-btn');
  const loginForm = document.getElementById('login-form'), profileForm = document.getElementById('profile-form'),
        messageForm = document.getElementById('message-form'), globalMessageForm = document.getElementById('global-message-form'),
        privateMessageForm = document.getElementById('private-message-form'), supportForm = document.getElementById('support-form'),
        ticketChatForm = document.getElementById('ticket-chat-form');
  const emailInput = document.getElementById('email'), passwordInput = document.getElementById('password'),
        usernameInput = document.getElementById('username-input'), genderSelect = document.getElementById('gender-select'),
        regionSelect = document.getElementById('region-select'), interestsInput = document.getElementById('interests-input'),
        avatarInput = document.getElementById('avatar-input'), messageInput = document.getElementById('message-input'),
        globalMessageInput = document.getElementById('global-message-input'), privateMessageInput = document.getElementById('private-message-input'),
        supportName = document.getElementById('support-name'), supportEmail = document.getElementById('support-email'),
        ticketChatMessageInput = document.getElementById('ticket-chat-message-input'), ticketChatStatusSelect = document.getElementById('ticket-chat-status-select'),
        ticketChatIdInput = document.getElementById('ticket-chat-id');
  const authErrorEl = document.getElementById('auth-error'), fullProfileErrorEl = document.getElementById('full-profile-error'),
        userProfileFooter = document.getElementById('user-profile-footer'), userAvatarHome = document.getElementById('user-avatar-home'),
        userNameHome = document.getElementById('user-name-home'), userRegionHome = document.getElementById('user-region-home'),
        friendRequestNotification = document.getElementById('friend-request-notification'), ticketNotification = document.getElementById('ticket-notification'),
        chatContainer = document.getElementById('chat-container'), partnerNameEl = document.getElementById('partner-name'),
        partnerInfoEl = document.getElementById('partner-info'), myAvatarChatEl = document.getElementById('my-avatar-chat'),
        partnerAvatarChatEl = document.getElementById('partner-avatar-chat'), onlineUsersEl = document.getElementById('online-users'),
        globalChatCard = document.getElementById('global-chat-card'), matchBtn = document.getElementById('match-btn'),
        privateChatCard = document.getElementById('private-chat-card'), globalOnlineUsersList = document.getElementById('global-online-users-list'),
        globalChatContainer = document.getElementById('global-chat-container'), privateChatNotification = document.getElementById('private-chat-notification'),
        contactsList = document.getElementById('contacts-list'), privateChatContainer = document.getElementById('private-chat-container'),
        privateChatPartnerAvatar = document.getElementById('private-chat-partner-avatar'), privateChatPartnerName = document.getElementById('private-chat-partner-name'),
        privateChatPartnerStatus = document.getElementById('private-chat-partner-status'), notificationsList = document.getElementById('notifications-list'),
        adminTicketsList = document.getElementById('admin-tickets-list'), adminFilters = document.getElementById('admin-filters'),
        userTicketsList = document.getElementById('user-tickets-list'), ticketChatModalContent = document.getElementById('ticket-chat-modal-content'),
        ticketChatModalHeader = document.getElementById('ticket-chat-modal-header'), ticketChatModalSubject = document.getElementById('ticket-chat-modal-subject'),
        ticketChatModalStatus = document.getElementById('ticket-chat-modal-status'), ticketChatMessagesContainer = document.getElementById('ticket-chat-messages-container'),
        ticketChatAdminControls = document.getElementById('ticket-chat-admin-controls'), ticketChatUserControls = document.getElementById('ticket-chat-user-controls'),
        ticketChatSendBtn = document.getElementById('ticket-chat-send-btn');
        
  // ---=== INITIALIZATION & BOOTSTRAP ===---
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database(); auth = firebase.auth(); storage = firebase.storage();
  } catch (e) {
    console.error("Initialization Failed:", e.message);
    document.body.innerHTML = `<div class="bg-black text-red-500 w-screen h-screen flex items-center justify-center p-4 text-center"><h1 class="text-2xl font-bold">ERRO CRÍTICO: ${e.message}. Verifique a configuração.</h1></div>`;
    return;
  }
  
  // ---=== UI HELPER & NAVIGATION FUNCTIONS ===---
  const setLoadingState = (isLoading, message = '') => {
      if (isLoading) {
          if(loadingMsg) loadingMsg.textContent = message;
          if(loadingOverlay) {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
          }
      } else {
          if(loadingOverlay) {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
          }
      }
  };

  const hideAllModals = () => {
    [profileModal, supportModal, vipModal, notificationsModal, userTicketsModal, ticketChatModal].forEach(modal => {
        if(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });
  };

  const showView = (view) => {
    hideAllModals();
    ['landing-screen', 'login-screen', 'home-screen', 'entry-screen', 'chat-screen', 'global-chat-screen', 'contacts-screen', 'private-chat-screen', 'admin-panel'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.add('hidden');
    });
    const viewMap = { landing: landingScreen, login: loginScreen, home: homeScreen, scanning: entryScreen, chat: chatScreen, 'global-chat': globalChatScreen, 'contacts': contactsScreen, 'private-chat': privateChatScreen, admin: adminPanel };
    const targetView = viewMap[view];
    if (targetView) {
        targetView.classList.remove('hidden');
        if (!targetView.classList.contains('flex')) targetView.classList.add('flex');
    }
  };
  const showProfileModal = (show) => { if (profileModal) { profileModal.classList.toggle('hidden', !show); profileModal.classList.toggle('flex', show); } };
  const showSupportModal = (show) => {
    if (show && currentUserProfile) { if(supportName) supportName.value = currentUserProfile.username; if(supportEmail) supportEmail.value = currentUser.email; }
    if (supportModal) { supportModal.classList.toggle('hidden', !show); supportModal.classList.toggle('flex', show); }
  };
  const showVipModal = (show) => { if(vipModal) { vipModal.classList.toggle('hidden', !show); vipModal.classList.toggle('flex', show); } };
  const showNotificationsModal = (show) => { if(notificationsModal) { notificationsModal.classList.toggle('hidden', !show); notificationsModal.classList.toggle('flex', show); } };
  const showUserTicketsModal = (show) => { if (userTicketsModal) { userTicketsModal.classList.toggle('hidden', !show); userTicketsModal.classList.toggle('flex', show); } };
  const populateRegions = () => {
    const states = ["Acre", "Alagoas", "Amapá", "Amazonas", "Bahia", "Ceará", "Distrito Federal", "Espírito Santo", "Goiás", "Maranhão", "Mato Grosso", "Mato Grosso do Sul", "Minas Gerais", "Pará", "Paraíba", "Paraná", "Pernambuco", "Piauí", "Rio de Janeiro", "Rio Grande do Norte", "Rio Grande do Sul", "Rondônia", "Roraima", "Santa Catarina", "São Paulo", "Sergipe", "Tocantins"];
    if (regionSelect) { states.forEach(state => regionSelect.add(new Option(state, state))); }
  };
   const updateUI = (profile) => {
      if (!profile) return;
      if (userAvatarHome) userAvatarHome.src = profile.avatar || 'https://i.pravatar.cc/150';
      if (userNameHome) userNameHome.textContent = profile.username;
      if (userRegionHome) userRegionHome.textContent = profile.region;
  };
   const populateProfileModal = (profile) => {
      if (!profile) return;
      if (usernameInput) usernameInput.value = profile.username || '';
      if (genderSelect) genderSelect.value = profile.gender || '';
      if (regionSelect) regionSelect.value = profile.region || '';
      if (interestsInput) interestsInput.value = profile.interests || '';
      if (avatarInput) avatarInput.value = profile.avatar || '';
  };
  
  // ---=== CORE APP LOGIC & AUTH ===---
  const handleAuthError = (error) => { setLoadingState(false); /* Unchanged */ };
  const managePresence = (user) => {
    const userStatusRef = db.ref(`/presence/${user.uid}`);
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => { if (snap.val() === true) { userStatusRef.set(true); userStatusRef.onDisconnect().remove(); }});
  };
  const listenForFriendRequests = (user) => { /* Unchanged */ };
  const listenForNotifications = (user) => { /* Unchanged */ };
  const startApp = () => {
    setLoadingState(true, 'Inicializando Vazio...');
    auth.getRedirectResult().catch(handleAuthError);
    auth.onAuthStateChanged((user) => {
      if (adminBtn) adminBtn.classList.add('hidden');
      if (currentUser) db.ref().off();
      if (user) {
        currentUser = user;
        console.log('Firebase Conectado:', user.uid);
        if (currentUser.uid === ADMIN_UID && adminBtn) adminBtn.classList.remove('hidden');
        const userRef = db.ref(`users/${user.uid}`);
        userRef.once('value').then(async (snapshot) => {
          const profile = snapshot.val();
          if (profile && profile.username) {
            currentUserProfile = profile;
            updateUI(currentUserProfile); populateProfileModal(currentUserProfile);
            showView('home');
            managePresence(user); listenForNotifications(user); listenForFriendRequests(user); listenForTicketReplies(user);
            
            // Listener for matchmaking
            const myUserRef = db.ref(`users/${currentUser.uid}`);
            if (matchMakingListener) myUserRef.child('currentChatRoomId').off('value', matchMakingListener);
            matchMakingListener = myUserRef.child('currentChatRoomId').on('value', snapshot => {
                const newRoomId = snapshot.val();
                if (newRoomId && newRoomId !== chatRoomId) {
                    const roomParticipantsRef = db.ref(`chat_rooms/${newRoomId}/participants`);
                    roomParticipantsRef.once('value').then(partSnap => {
                        if (partSnap.exists()) {
                            const pId = Object.keys(partSnap.val()).find(id => id !== currentUser.uid);
                            if(pId) enterChatRoom(newRoomId, pId);
                        }
                    });
                }
            });

          } else {
            currentUserProfile = null; showProfileModal(true);
          }
          setLoadingState(false);
        }).catch((error) => { setLoadingState(false); showView('login'); });
      } else {
        currentUser = null; currentUserProfile = null;
        showView('landing');
        setLoadingState(false);
      }
    });
  };

  // ---=== CHAT, MATCHING & FRIENDS LOGIC (RESTORED & REFINED) ===---
    const resetRandomChatState = async () => {
        if (roomRef) {
            if (messagesListener) roomRef.child('messages').off('child_added', messagesListener);
            await roomRef.remove().catch(e => console.error("Error removing room:", e));
        }
        
        const updates = {};
        if (currentUser) {
            updates[`users/${currentUser.uid}/currentChatRoomId`] = null;
            updates[`users/${currentUser.uid}/searching`] = false;
        }
        if (partnerId) {
            updates[`users/${partnerId}/currentChatRoomId`] = null;
        }
        await db.ref().update(updates).catch(e => console.error("Error updating users:", e));

        chatRoomId = null;
        partnerId = null;
        roomRef = null;
        messagesListener = null;
        if(chatContainer) chatContainer.innerHTML = '';
    };
    
    const exitRandomChat = async () => {
        await resetRandomChatState();
        showView('home');
    };

    const findNextPartner = async () => {
        await resetRandomChatState();
        findPartner();
    };

    const renderMessage = (msg, container, isGlobal = false, partnerProfile = null) => {
        if (!currentUser || !msg) return;
        const isMe = msg.senderId === currentUser.uid;
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex items-start gap-3 mb-4 ${isMe ? 'justify-end' : 'fade-in'}`;
        
        let senderName, senderAvatar;

        if (isGlobal) {
            senderName = msg.senderName;
            senderAvatar = msg.senderAvatar;
        } else {
            senderName = isMe ? currentUserProfile.username : (partnerProfile ? partnerProfile.username : 'Estranho');
            senderAvatar = isMe ? currentUserProfile.avatar : (partnerProfile ? partnerProfile.avatar : 'https://i.pravatar.cc/150');
        }

        const content = `
            <div class="${isMe ? 'order-1' : ''}">
                <img src="${senderAvatar}" class="w-10 h-10 rounded-full">
            </div>
            <div class="max-w-xs md:max-w-md ${isMe ? 'bg-cyan-800' : 'bg-gray-700'} rounded-lg p-3">
                <p class="font-bold ${msg.isVip ? 'vip-name' : ''} ${isMe ? 'text-cyan-300' : 'text-white'}">${senderName}</p>
                <p class="text-white break-words">${msg.text}</p>
            </div>`;
        msgDiv.innerHTML = content;
        if(container) {
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }
    };

    const enterGlobalChat = () => {
        if (!currentUserProfile) return;
        showView('global-chat');
        if (globalChatContainer) globalChatContainer.innerHTML = '';
        
        const messagesRef = db.ref('global_chat').limitToLast(100);
        if (globalMessagesListener) messagesRef.off('child_added', globalMessagesListener);
        globalMessagesListener = messagesRef.on('child_added', snapshot => {
            renderMessage(snapshot.val(), globalChatContainer, true);
        });

        const presenceRef = db.ref('presence');
        if (globalOnlineListener) presenceRef.off('value', globalOnlineListener);
        globalOnlineListener = presenceRef.on('value', async snapshot => {
          if (!snapshot.exists() || !globalOnlineUsersList) return;
          globalOnlineUsersList.innerHTML = '';
          const onlineUIDs = Object.keys(snapshot.val());
          for (const uid of onlineUIDs) {
            const userSnap = await db.ref(`users/${uid}`).once('value');
            if (userSnap.exists()) {
              const profile = userSnap.val();
              const userEl = document.createElement('div');
              userEl.className = 'flex items-center gap-3 p-2 rounded-md hover:bg-cyan-900/50 cursor-pointer';
              userEl.innerHTML = `<img src="${profile.avatar}" class="w-8 h-8 rounded-full border-2 border-cyan-400"> <p>${profile.username}</p>`;
              globalOnlineUsersList.appendChild(userEl);
            }
          }
        });
    };
    
    const findPartner = async () => {
        if (!currentUser) return;
        showView('scanning');
        const myRef = db.ref(`users/${currentUser.uid}`);
        await myRef.update({ searching: true, currentChatRoomId: null });
        myRef.child('searching').onDisconnect().remove();

        const searchRef = db.ref('users').orderByChild('searching').equalTo(true);
        const onMatchFound = async (snapshot) => {
            let partnerFound = false;
            snapshot.forEach(childSnapshot => {
                const partnerUid = childSnapshot.key;
                if (partnerUid !== currentUser.uid && !partnerFound) {
                    partnerFound = true;
                    searchRef.off('value', onMatchFound);
                    createMatch(partnerUid);
                }
            });
        };
        searchRef.on('value', onMatchFound);
    };

    const createMatch = async (pId) => {
        if (!currentUser) return;
        const newChatRoomId = [currentUser.uid, pId].sort().join('_');
        const updates = {};
        updates[`users/${currentUser.uid}/searching`] = null;
        updates[`users/${currentUser.uid}/currentChatRoomId`] = newChatRoomId;
        updates[`users/${pId}/searching`] = null;
        updates[`users/${pId}/currentChatRoomId`] = newChatRoomId;
        updates[`chat_rooms/${newChatRoomId}/participants`] = { [currentUser.uid]: true, [pId]: true };
        await db.ref().update(updates);
    };

    const enterChatRoom = async (roomId, pId) => {
        chatRoomId = roomId;
        partnerId = pId;
        const partnerSnap = await db.ref(`users/${pId}`).once('value');
        const partnerProfile = partnerSnap.val();
        
        if(myAvatarChatEl && currentUserProfile) myAvatarChatEl.src = currentUserProfile.avatar;
        if(partnerAvatarChatEl && partnerProfile) partnerAvatarChatEl.src = partnerProfile.avatar;
        if(partnerNameEl && partnerProfile) partnerNameEl.textContent = partnerProfile.username;
        if(partnerInfoEl && partnerProfile) partnerInfoEl.textContent = `${partnerProfile.region} - ${partnerProfile.gender}`;
        
        showView('chat');
        if(chatContainer) chatContainer.innerHTML = '';
        
        roomRef = db.ref(`chat_rooms/${roomId}`);
        roomRef.onDisconnect().remove();
        if(messagesListener) roomRef.child('messages').off('child_added', messagesListener);
        messagesListener = roomRef.child('messages').on('child_added', snapshot => {
            renderMessage(snapshot.val(), chatContainer, false, partnerProfile);
        });
    };

  const enterContactsScreen = () => { /* Unchanged but will be called */ };
  
  // ---=== SUPPORT TICKET CHAT SYSTEM (UNCHANGED) ===---
  const listenForTicketReplies = (user) => {
    const ticketsRef = db.ref('support_tickets').orderByChild('userId').equalTo(user.uid);
    if(ticketRepliesListener) ticketsRef.off('value', ticketRepliesListener);
    ticketRepliesListener = ticketsRef.on('value', snapshot => {
        const tickets = snapshot.val() || {};
        const hasUnread = Object.values(tickets).some(ticket => ticket.user_notified === false);
        if (ticketNotification) ticketNotification.classList.toggle('hidden', !hasUnread);
    });
  }
  const showTicketChatModal = (show) => {
    if (show) { if (ticketChatModal) { ticketChatModal.classList.remove('hidden'); ticketChatModal.classList.add('flex'); } }
    else { if (ticketChatModal) { ticketChatModal.classList.add('hidden'); ticketChatModal.classList.remove('flex'); } }
  };
  const openTicketChatModal = (ticketId, role) => {
    const ticketRef = db.ref(`support_tickets/${ticketId}`);
    if (currentTicketChatListener) currentTicketChatListener.ref.off('value', currentTicketChatListener.listener);
    
    const listener = ticketRef.on('value', snapshot => {
        const ticketData = snapshot.val();
        if (!ticketData) { closeTicketChatModal(); alert("Chamado não encontrado."); return; }
        const isAdmin = role === 'admin';
        if (ticketChatModalContent) ticketChatModalContent.style.borderColor = isAdmin ? '#22c55e' : '#22d3ee';
        if (ticketChatModalHeader) ticketChatModalHeader.style.borderBottomColor = isAdmin ? 'rgba(34, 197, 94, 0.3)' : 'rgba(34, 211, 238, 0.3)';
        if (ticketChatSendBtn) ticketChatSendBtn.style.backgroundColor = isAdmin ? '#22c55e' : '#22d3ee';
        if (ticketChatMessageInput) ticketChatMessageInput.style.borderColor = isAdmin ? '#22c55e' : '#22d3ee';
        if (ticketChatModalSubject) ticketChatModalSubject.textContent = ticketData.subject;
        if (ticketChatIdInput) ticketChatIdInput.value = ticketId;
        const statusColors = { 'Resolvido': 'text-green-400', 'Aguardando Admin': 'text-yellow-400', 'Aguardando Retorno do Cliente': 'text-blue-400', 'Aberto': 'text-gray-400' };
        if (ticketChatModalStatus) {
            ticketChatModalStatus.textContent = ticketData.status;
            ticketChatModalStatus.className = `text-sm ${statusColors[ticketData.status] || 'text-gray-400'}`;
        }
        if (ticketChatAdminControls) ticketChatAdminControls.classList.toggle('hidden', !isAdmin);
        if (ticketChatUserControls) ticketChatUserControls.classList.toggle('hidden', isAdmin || ticketData.status !== 'Resolvido');
        if (isAdmin && ticketChatStatusSelect) ticketChatStatusSelect.value = ticketData.status;
        if (ticketChatMessagesContainer) {
            ticketChatMessagesContainer.innerHTML = '';
            Object.values(ticketData.messages || {}).forEach(msg => {
                const isMyMessage = msg.senderId === (isAdmin ? 'admin' : currentUser.uid);
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex flex-col ${isMyMessage ? 'items-end' : 'items-start'}`;
                msgDiv.innerHTML = `<div class="max-w-md"><p class="text-xs mb-1 ${isMyMessage ? 'text-right text-cyan-400' : 'text-left text-gray-400'}">${msg.senderName}</p><div class="px-4 py-2 rounded-lg ${isMyMessage ? 'bg-cyan-800' : 'bg-gray-700'}"><p class="text-sm break-words">${msg.text}</p></div></div>`;
                ticketChatMessagesContainer.appendChild(msgDiv);
            });
            ticketChatMessagesContainer.scrollTop = ticketChatMessagesContainer.scrollHeight;
        }
        showTicketChatModal(true);
    });
    currentTicketChatListener = { ref: ticketRef, listener: listener };
    if (role === 'user') ticketRef.update({ user_notified: true });
  };
  const closeTicketChatModal = () => {
    if (currentTicketChatListener) { currentTicketChatListener.ref.off('value', currentTicketChatListener.listener); currentTicketChatListener = null; }
    showTicketChatModal(false);
  };
  const renderAdminTickets = (filter = 'Pendentes') => {
    if (!adminTicketsList) return;
    adminTicketsList.innerHTML = '';
    const tickets = currentAdminTicketData || {};
    const pendingStatuses = ['Aberto', 'Aguardando Admin', 'Aguardando Retorno do Cliente'];
    const filteredTickets = Object.entries(tickets).filter(([, ticket]) => {
        if (filter === 'Pendentes') return pendingStatuses.includes(ticket.status);
        return ticket.status === filter;
    });
    if (filteredTickets.length === 0) { adminTicketsList.innerHTML = `<p class="text-gray-500 text-center">Nenhum ticket '${filter}'.</p>`; return; }
    const sortedTickets = filteredTickets.sort(([, a], [, b]) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
    sortedTickets.forEach(([key, ticket]) => {
        const ticketEl = document.createElement('div');
        ticketEl.className = 'bg-black/50 border border-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-800/50';
        ticketEl.dataset.ticketId = key;
        const firstMessage = Object.values(ticket.messages || {})[0]?.text || 'Sem mensagem inicial.';
        ticketEl.innerHTML = `<p class="font-bold text-cyan-400">${ticket.subject}</p><p class="text-sm text-gray-400">De: ${ticket.name} - Status: ${ticket.status}</p><p class="text-xs text-gray-500 truncate mt-1">${firstMessage}</p>`;
        adminTicketsList.appendChild(ticketEl);
    });
  };
  const openAdminPanel = () => {
    showView('admin');
    const ticketsRef = db.ref('support_tickets');
    if (adminTicketsListener) ticketsRef.off('value', adminTicketsListener);
    adminTicketsListener = ticketsRef.on('value', snapshot => {
        currentAdminTicketData = snapshot.val() || {};
        const currentFilter = document.querySelector('.admin-filter-btn.active')?.dataset.filter || 'Pendentes';
        renderAdminTickets(currentFilter);
    });
  };
  const leaveAdminPanel = () => {
    if (adminTicketsListener) db.ref('support_tickets').off('value', adminTicketsListener);
    showView('home');
  };
  const enterMyTicketsView = () => {
     if(!currentUser || !userTicketsList) return;
     showUserTicketsModal(true);
     const ticketsRef = db.ref('support_tickets').orderByChild('userId').equalTo(currentUser.uid);
     if (userTicketsListener) ticketsRef.off('value', userTicketsListener);
     userTicketsListener = ticketsRef.on('value', snapshot => {
         const tickets = snapshot.val() || {};
         userTicketsList.innerHTML = '';
         if (Object.keys(tickets).length === 0) { userTicketsList.innerHTML = `<p class="text-gray-500 text-center">Você não enviou nenhum chamado.</p>`; return; }
         const sortedTickets = Object.entries(tickets).sort(([, a], [, b]) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
         sortedTickets.forEach(([key, ticket]) => {
             const ticketEl = document.createElement('div');
             ticketEl.className = 'bg-gray-800/50 p-3 rounded-lg cursor-pointer hover:bg-cyan-900/50';
             ticketEl.dataset.ticketId = key;
             const hasUnread = ticket.user_notified === false ? '<span class="text-red-500 ml-2">(Nova Resposta)</span>' : '';
             ticketEl.innerHTML = `<p class="font-bold text-cyan-400">${ticket.subject} ${hasUnread}</p><p class="text-xs">Status: ${ticket.status}</p>`;
             userTicketsList.appendChild(ticketEl);
         });
     });
  };
  const leaveMyTicketsView = () => {
      if(currentUser) {
          const ticketsRef = db.ref('support_tickets').orderByChild('userId').equalTo(currentUser.uid);
          if (userTicketsListener) ticketsRef.off('value', userTicketsListener);
      }
      showUserTicketsModal(false);
  };
  
  // ---=== EVENT LISTENERS (Error-Proofed & Prioritized) ===---
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(startApp).catch(startApp);
  populateRegions();

  if (globalChatCard) { globalChatCard.addEventListener('click', enterGlobalChat); }
  if (matchBtn) { matchBtn.addEventListener('click', () => { if (currentUserProfile) findPartner(); }); }
  if (privateChatCard) { privateChatCard.addEventListener('click', enterContactsScreen); }
  if (enterVoidBtn) { enterVoidBtn.addEventListener('click', () => showView('login')); }
  if (loginForm) { loginForm.addEventListener('submit', (e) => { e.preventDefault(); if (loginBtn) loginBtn.click(); }); }
  if (loginBtn) { loginBtn.addEventListener('click', () => auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value).catch(handleAuthError)); }
  if (signupBtn) { signupBtn.addEventListener('click', () => auth.createUserWithEmailAndPassword(emailInput.value.trim(), passwordInput.value).catch(handleAuthError)); }
  if (googleSigninBtn) { googleSigninBtn.addEventListener('click', () => auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider()).catch(handleAuthError)); }
  if (profileForm) {
    profileForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const profileData = { username: usernameInput.value.trim(), gender: genderSelect.value, region: regionSelect.value, interests: interestsInput.value.trim(), avatar: avatarInput.value.trim() };
      if (!Object.values(profileData).every(Boolean)) { if(fullProfileErrorEl) fullProfileErrorEl.textContent = 'Preencha todos os campos.'; return; }
      saveFullProfileBtn.disabled = true;
      db.ref(`users/${currentUser.uid}`).update(profileData).then(() => location.reload());
    });
  }
  if (messageForm) { messageForm.addEventListener('submit', e => { e.preventDefault(); if (messageInput.value.trim() && chatRoomId) { db.ref(`chat_rooms/${chatRoomId}/messages`).push({ senderId: currentUser.uid, text: messageInput.value.trim(), isVip: currentUserProfile.isVip || false, timestamp: firebase.database.ServerValue.TIMESTAMP }); messageInput.value = ''; }}); }
  if (globalMessageForm) { if (globalMessageInput) globalMessageForm.addEventListener('submit', (e) => { e.preventDefault(); if(globalMessageInput.value.trim()){ db.ref('global_chat').push({ senderId: currentUser.uid, senderName: currentUserProfile.username, senderAvatar: currentUserProfile.avatar, text: globalMessageInput.value.trim(), isVip: currentUserProfile.isVip || false, timestamp: firebase.database.ServerValue.TIMESTAMP }); globalMessageInput.value = ''; } }); }
  if (globalChatBackBtn) { globalChatBackBtn.addEventListener('click', () => showView('home')); }
  if (userProfileFooter) { userProfileFooter.addEventListener('click', () => showProfileModal(true)); }
  if (notificationsBtn) { notificationsBtn.addEventListener('click', () => showNotificationsModal(true)); }
  if (notificationsCloseBtn) { notificationsCloseBtn.addEventListener('click', () => showNotificationsModal(false)); }
  if (vipModalCloseBtn) { vipModalCloseBtn.addEventListener('click', () => showVipModal(false)); }
  if (randomChatExitBtn) { randomChatExitBtn.addEventListener('click', exitRandomChat); }
  if (nextBtn) { nextBtn.addEventListener('click', findNextPartner); }
  
  // Support & Tickets System
  if (myTicketsBtn) { myTicketsBtn.addEventListener('click', enterMyTicketsView); }
  if (userTicketsCloseBtn) { userTicketsCloseBtn.addEventListener('click', leaveMyTicketsView); }
  if (openNewTicketBtn) { openNewTicketBtn.addEventListener('click', () => showSupportModal(true)); }
  if (supportModalCloseBtn) { supportModalCloseBtn.addEventListener('click', () => showSupportModal(false)); }
  if (supportForm) {
    supportForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const messageData = { text: e.target.elements['support-description'].value, senderId: currentUser.uid, senderName: currentUserProfile.username, timestamp: firebase.database.ServerValue.TIMESTAMP };
      const ticketData = { name: e.target.elements['support-name'].value, email: e.target.elements['support-email'].value, subject: e.target.elements['support-subject'].value, userId: currentUser.uid, status: 'Aguardando Admin', user_notified: true, createdAt: firebase.database.ServerValue.TIMESTAMP, lastUpdated: firebase.database.ServerValue.TIMESTAMP };
      const newTicketRef = db.ref('support_tickets').push(ticketData);
      newTicketRef.child('messages').push(messageData).then(() => { alert('Chamado enviado!'); supportForm.reset(); showSupportModal(false); });
    });
  }
  if (userTicketsList) { userTicketsList.addEventListener('click', (e) => { const el = e.target.closest('[data-ticket-id]'); if(el) openTicketChatModal(el.dataset.ticketId, 'user'); }); }

  // Admin Panel
  if (adminBtn) { adminBtn.addEventListener('click', openAdminPanel); }
  if (adminPanelBackBtn) { adminPanelBackBtn.addEventListener('click', leaveAdminPanel); }
  if (adminFilters) { adminFilters.addEventListener('click', (e) => { if(e.target.classList.contains('admin-filter-btn')) { document.querySelectorAll('.admin-filter-btn').forEach(btn=>btn.classList.remove('active')); e.target.classList.add('active'); renderAdminTickets(e.target.dataset.filter); } }); }
  if (adminTicketsList) { adminTicketsList.addEventListener('click', (e) => { const el = e.target.closest('[data-ticket-id]'); if(el) openTicketChatModal(el.dataset.ticketId, 'admin'); }); }
  
  // Ticket Chat Modal
  if (ticketChatModalCloseBtn) { ticketChatModalCloseBtn.addEventListener('click', closeTicketChatModal); }
  if (ticketChatForm) {
    ticketChatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const ticketId = ticketChatIdInput.value, text = ticketChatMessageInput.value.trim(); if (!ticketId || !text) return;
      const isAdmin = currentUser.uid === ADMIN_UID;
      const messageData = { text, senderId: isAdmin ? 'admin' : currentUser.uid, senderName: isAdmin ? 'Admin' : currentUserProfile.username, timestamp: firebase.database.ServerValue.TIMESTAMP };
      const updates = { status: isAdmin ? 'Aguardando Retorno do Cliente' : 'Aguardando Admin', lastUpdated: firebase.database.ServerValue.TIMESTAMP, user_notified: !isAdmin };
      db.ref(`support_tickets/${ticketId}/messages`).push(messageData);
      db.ref(`support_tickets/${ticketId}`).update(updates);
      ticketChatMessageInput.value = '';
    });
  }
  if (ticketChatStatusSelect) { ticketChatStatusSelect.addEventListener('change', (e) => { if (ticketChatIdInput.value) db.ref(`support_tickets/${ticketChatIdInput.value}`).update({ status: e.target.value, lastUpdated: firebase.database.ServerValue.TIMESTAMP }); }); }
  if (ticketChatDeleteBtn) { ticketChatDeleteBtn.addEventListener('click', () => { if (ticketChatIdInput.value && confirm("Tem certeza que deseja apagar este chamado permanentemente?")) { db.ref(`support_tickets/${ticketChatIdInput.value}`).remove().then(closeTicketChatModal); }}); }
});
</script>

</body>
</html>